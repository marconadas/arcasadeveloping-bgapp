<!doctype html>
<html lang="pt">
<head>
    <!-- Favicon BGAPP -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <meta name="theme-color" content="#173c72">
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BGAPP - Mapa Meteorol√≥gico Interativo</title>
  
  <!-- Content Security Policy -->
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; 
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' 
                           https://unpkg.com 
                           https://cdnjs.cloudflare.com; 
                 style-src 'self' 'unsafe-inline' 
                          https://unpkg.com 
                          https://netdna.bootstrapcdn.com; 
                 font-src 'self' 
                          https://unpkg.com 
                          https://netdna.bootstrapcdn.com 
                          data:; 
                 img-src 'self' data: blob: 
                        https://tiles.maps.eox.at 
                        https://www.gebco.net 
                        https://services.sentinel-hub.com 
                        https://tiles.arcgis.com
                        https://a.tile.openstreetmap.org
                        https://b.tile.openstreetmap.org
                        https://c.tile.openstreetmap.org
                        https://a.basemaps.cartocdn.com
                        https://b.basemaps.cartocdn.com
                        https://c.basemaps.cartocdn.com
                        https://d.basemaps.cartocdn.com
                        https://server.arcgisonline.com
                        https://stamen-tiles-a.a.ssl.fastly.net
                        https://stamen-tiles-b.a.ssl.fastly.net
                        https://stamen-tiles-c.a.ssl.fastly.net
                        https://stamen-tiles-d.a.ssl.fastly.net
                        https://tile.stamen.com
                        https://tiles.stadiamaps.com
                        https://unpkg.com; 
                 connect-src 'self' 
                            https://tiles.maps.eox.at 
                            https://www.gebco.net 
                            https://services.sentinel-hub.com 
                            https://copernicus.eu 
                            https://stamen-tiles-a.a.ssl.fastly.net
                            https://stamen-tiles-b.a.ssl.fastly.net
                            https://stamen-tiles-c.a.ssl.fastly.net
                            https://stamen-tiles-d.a.ssl.fastly.net
                            https://tile.stamen.com
                            https://tiles.stadiamaps.com
                            wss:;">
  
  <!-- Meta Tags SEO -->
  <meta name="description" content="BGAPP - Sistema avan√ßado de monitoramento oceanogr√°fico e meteorol√≥gico marinho de Angola.">
  <meta name="keywords" content="oceanografia, meteorologia, Angola, SST, correntes marinhas, batimetria, GEBCO, Sentinel-2, Copernicus">
  <meta name="author" content="BGAPP Development Team">
  
  <!-- PWA Meta Tags -->
  
  <meta name="application-name" content="BGAPP">
  <link rel="manifest" href="/manifest.json">
  
  <!-- Favicon -->
  
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <!-- TIMEDIMENSION DESATIVADO TEMPORARIAMENTE:
  <link rel="stylesheet" href="https://unpkg.com/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.control.min.css"/>
  -->
  <link rel="stylesheet" href="assets/css/map-styles.css?v=20250115fresh">
  <style>
    /* APPLE DESIGN SYSTEM - PAINEL FLUTUANTE */
    :root {
      --apple-blue: #007AFF;
      --apple-green: #34C759;
      --apple-orange: #FF9500;
      --apple-red: #FF3B30;
      --apple-teal: #5AC8FA;
      --surface-elevated: rgba(255, 255, 255, 0.95);
      --border: rgba(0, 0, 0, 0.1);
      --shadow-elevated: 0 8px 30px rgba(0, 0, 0, 0.12);
      --transition-smooth: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      --radius-lg: 16px;
      --spacing-lg: 24px;
      --spacing-md: 16px;
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --surface-elevated: rgba(44, 44, 46, 0.95);
        --border: rgba(255, 255, 255, 0.1);
      }
    }
    
    /* Base - Mapa em tela cheia */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    
    #map {
      width: 100vw !important;
      height: 100vh !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      z-index: 1 !important;
    }
    
    /* Painel flutuante retr√°til */
    #toolbar {
      position: fixed !important;
      top: var(--spacing-lg) !important;
      left: var(--spacing-lg) !important;
      width: 320px;
      max-height: calc(100vh - 48px);
      background: var(--surface-elevated);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-elevated);
      border: 1px solid var(--border);
      z-index: 1000;
      transform: translateX(0);
      transition: transform var(--transition-smooth), opacity var(--transition-smooth);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    #toolbar.collapsed {
      transform: translateX(-280px);
      opacity: 0.9;
    }
    
    /* Header do painel */
    #toolbar header {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.8);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    #app-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    /* Bot√£o de toggle */
    .panel-toggle {
      width: 32px;
      height: 32px;
      border: none;
      background: #f2f2f7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #666;
    }
    
    .panel-toggle:hover {
      background: #e5e5ea;
      transform: scale(1.05);
    }
    
    /* Conte√∫do do painel */
    .toolbar-section {
      margin-bottom: var(--spacing-md);
      padding: 0 var(--spacing-md);
    }
    
    .toolbar-section h2 {
      font-size: 13px;
      font-weight: 600;
      color: #8e8e93;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    /* Bot√µes modernizados */
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 36px;
      position: relative;
      overflow: hidden;
      margin: 2px;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn.ocean {
      background: var(--apple-teal);
      color: white;
    }
    
    .btn.meteo {
      background: var(--apple-orange);
      color: white;
    }
    
    .btn.control {
      background: #f2f2f7;
      color: #000;
    }
    
    .btn.animate {
      background: #af52de;
      color: white;
    }
    
    .btn.active {
      background: var(--apple-green) !important;
      color: white;
      box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
    }
    
    .btn-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: 8px;
      margin-bottom: 16px;
    }
    
    /* Input de data */
    input[type="date"] {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    input[type="date"]:focus {
      outline: none;
      border-color: var(--apple-blue);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2);
    }
    
    /* Status */
    footer {
      padding: var(--spacing-md);
      border-top: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.8);
      margin-top: auto;
    }
    
    /* Bot√£o flutuante (quando painel est√° recolhido) */
    #floating-toggle {
      position: fixed;
      top: var(--spacing-lg);
      left: var(--spacing-lg);
      width: 48px;
      height: 48px;
      border: none;
      background: var(--surface-elevated);
      backdrop-filter: blur(20px);
      border-radius: 50%;
      box-shadow: var(--shadow-elevated);
      border: 1px solid var(--border);
      cursor: pointer;
      z-index: 1001;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s ease;
    }
    
    #floating-toggle:hover {
      transform: scale(1.05);
    }
    
    #floating-toggle.show {
      display: flex;
    }
    
    /* Legenda modernizada */
    #legend {
      position: fixed;
      bottom: var(--spacing-lg);
      right: var(--spacing-lg);
      background: var(--surface-elevated);
      backdrop-filter: blur(20px);
      border-radius: 12px;
      box-shadow: var(--shadow-elevated);
      border: 1px solid var(--border);
      z-index: 1000;
    }
    
    /* Responsivo */
    @media (max-width: 768px) {
      #toolbar {
        width: calc(100vw - 32px);
        left: 16px;
        right: 16px;
        top: 16px;
        max-height: 60vh;
      }
      
      #toolbar.collapsed {
        transform: translateY(-100%);
      }
      
      #floating-toggle {
        top: 16px;
        left: 16px;
      }
    }
  </style>
</head>
<body>
  <nav id="toolbar" role="navigation" aria-label="Controles do Mapa Meteorol√≥gico">
    <header>
      <h1 id="app-title" tabindex="0">üåä BGAPP - Meteorologia Marinha</h1>
      <button class="panel-toggle" id="panel-toggle" aria-label="Recolher painel">
        <span>‚Üê</span>
      </button>
    </header>

    <section class="toolbar-section" aria-labelledby="filters-heading">
      <h2 id="filters-heading" class="sr-only">Filtros Temporais</h2>
      <label for="dateMin" style="font-size: 12px; color: #666;">
        Data m√≠nima:
        <input type="date" 
               id="dateMin" 
               value="2024-06-01"
               aria-describedby="date-help"
               aria-label="Selecionar data m√≠nima para filtros">
      </label>
      <div id="date-help" class="sr-only">
        Formato: DD/MM/AAAA. Selecione a data inicial para visualiza√ß√£o dos dados.
      </div>
      <button id="apply" 
              class="btn" 
              style="margin-top: 4px;"
              aria-describedby="apply-help">
        <span aria-hidden="true">üîç</span>
        Aplicar Filtro
      </button>
      <div id="apply-help" class="sr-only">
        Aplica o filtro de data selecionado aos dados meteorol√≥gicos
      </div>
    </section>

    <section class="toolbar-section" aria-labelledby="ocean-heading">
      <h2 id="ocean-heading" style="margin: 0 0 6px 0; font-size: 13px; color: #34495e;">
        üå°Ô∏è Vari√°veis Oceanogr√°ficas
      </h2>
      <div class="btn-group" role="group" aria-labelledby="ocean-heading">
        <button id="btn-sst" 
                class="btn ocean"
                aria-label="Temperatura da Superf√≠cie do Mar"
                aria-describedby="sst-help"
                role="button"
                tabindex="0"
                aria-pressed="false">
          <span aria-hidden="true">üå°Ô∏è</span>
          SST
        </button>
        <div id="sst-help" class="sr-only">
          Visualizar dados de temperatura da superf√≠cie do mar
        </div>

        <button id="btn-salinity" 
                class="btn ocean"
                aria-label="Salinidade da √Ågua do Mar"
                aria-describedby="salinity-help"
                role="button"
                tabindex="0"
                aria-pressed="false">
          <span aria-hidden="true">üßÇ</span>
          Salinidade
        </button>
        <div id="salinity-help" class="sr-only">
          Visualizar dados de salinidade da √°gua do mar
        </div>

        <button id="btn-chlorophyll" 
                class="btn ocean"
                aria-label="Concentra√ß√£o de Clorofila"
                aria-describedby="chlorophyll-help"
                role="button"
                tabindex="0"
                aria-pressed="false">
          <span aria-hidden="true">üåø</span>
          Clorofila
        </button>
        <div id="chlorophyll-help" class="sr-only">
          Visualizar concentra√ß√£o de clorofila na √°gua
        </div>
      </div>
    </section>

    <section class="toolbar-section" aria-labelledby="vector-heading">
      <h2 id="vector-heading" style="margin: 0 0 6px 0; font-size: 13px; color: #34495e;">
        üí® Campos Vetoriais
      </h2>
      <div class="btn-group" role="group" aria-labelledby="vector-heading">
        <button id="btn-currents" 
                class="btn meteo"
                aria-label="Correntes Mar√≠timas"
                aria-describedby="currents-help"
                role="button"
                tabindex="0"
                aria-pressed="false">
          <span aria-hidden="true">üåä</span>
          Correntes
        </button>
        <div id="currents-help" class="sr-only">
          Visualizar dire√ß√£o e intensidade das correntes mar√≠timas
        </div>

        <button id="btn-wind" 
                class="btn meteo"
                aria-label="Velocidade e Dire√ß√£o do Vento"
                aria-describedby="wind-help"
                role="button"
                tabindex="0"
                aria-pressed="false">
          <span aria-hidden="true">üí®</span>
          Vento
        </button>
        <div id="wind-help" class="sr-only">
          Visualizar velocidade e dire√ß√£o do vento
        </div>
      </div>
    </section>

    <section class="toolbar-section" aria-labelledby="controls-heading">
      <h2 id="controls-heading" style="margin: 0 0 6px 0; font-size: 13px; color: #34495e;">
        ‚öôÔ∏è Controles
      </h2>
      <div class="btn-group" role="group" aria-labelledby="controls-heading">
        <button id="btn-clear" 
                class="btn control" 
                style="background: #95a5a6;"
                aria-label="Limpar Todas as Camadas do Mapa"
                aria-describedby="clear-help"
                role="button"
                tabindex="0">
          <span aria-hidden="true">üóëÔ∏è</span>
          Limpar Tudo
        </button>
        <div id="clear-help" class="sr-only">
          Remove todas as camadas ativas do mapa
        </div>

        <button id="btn-animate" 
                class="btn animate" 
                style="background: #9b59b6;"
                aria-label="Iniciar Anima√ß√£o Temporal"
                aria-describedby="animate-help"
                aria-pressed="false"
                role="button"
                tabindex="0">
          <span aria-hidden="true" id="animate-icon">‚ñ∂Ô∏è</span>
          <span id="animate-text">Animar</span>
        </button>
        <div id="animate-help" class="sr-only">
          Inicia ou para a anima√ß√£o temporal dos dados meteorol√≥gicos
        </div>

        <button id="btn-disable-eox" 
                class="btn control" 
                style="background: #ff3b30; color: white; font-size: 11px;"
                aria-label="Desabilitar EOX em caso de problemas"
                role="button"
                tabindex="0">
          <span aria-hidden="true">üö´</span>
          EOX OFF
        </button>
      </div>
    </section>

    <footer style="margin-top: 8px; font-size: 11px; color: #7f8c8d;">
      <div role="status" aria-live="polite" aria-label="Status do Sistema">
        <span class="status-indicator status-online" aria-hidden="true"></span>
        <span id="system-status">Sistema Online</span>
      </div>
    </footer>
  </nav>
  
  <!-- Bot√£o flutuante (quando painel est√° recolhido) -->
  <button id="floating-toggle" aria-label="Mostrar painel de controles">
    ‚öôÔ∏è
  </button>
  
  <!-- Regi√£o principal do mapa -->
  <main role="main" aria-label="Mapa Interativo Meteorol√≥gico">
    <div id="map" 
         role="application" 
         aria-label="Mapa interativo com dados meteorol√≥gicos e oceanogr√°ficos de Angola"
         tabindex="0"></div>
  </main>

  <!-- Legenda -->
  <aside id="legend" 
         class="legend" 
         role="complementary" 
         aria-labelledby="legend-title"
         aria-live="polite">
    <h3 id="legend-title" style="margin: 0 0 8px 0; font-size: 13px;">Legenda</h3>
    <div id="legend-content" aria-describedby="legend-description"></div>
    <div id="legend-description" class="sr-only">
      Informa√ß√µes sobre cores e s√≠mbolos utilizados no mapa
    </div>
  </aside>

  <!-- Scripts essenciais -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- POLYFILLS E TIMEDIMENSION DESATIVADOS TEMPORARIAMENTE:
  <script src="assets/js/nezasa-polyfill.js?v=fresh"></script>
  <script src="https://unpkg.com/leaflet-timedimension@1.1.1/dist/leaflet.timedimension.min.js"></script>
  -->

  <!-- Scripts do sistema -->
  <script src="assets/js/zee_angola_official.js?v=fresh"></script>
  <script src="assets/js/eox-layers.js?v=fresh"></script>
  <script src="assets/js/bathymetry-gebco.js?v=fresh"></script>
  <!-- Sistema de Funcionalidades Reais - NOVO -->
  <script src="assets/js/real-functionality.js?v=2.0.0"></script>
  <!-- SCRIPTS OPCIONAIS (reativar gradualmente):
  <script src="assets/js/sentinel2-integration.js?v=fresh"></script>
  <script src="assets/js/attribution-system.js?v=fresh"></script>
  <script src="assets/js/copernicus-integration.js?v=fresh"></script>
  <script src="assets/js/projection-manager.js?v=fresh"></script>
  <script src="assets/js/offline-capability.js?v=fresh"></script>
  <script src="assets/js/3d-visualization.js?v=fresh"></script>
  -->

  <!-- Service Worker Registration -->
  <script>
    // Registrar Service Worker para controle de cache
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('‚úÖ Service Worker registrado:', registration.scope);
          })
          .catch(error => {
            console.log('‚ùå Falha no registro do Service Worker:', error);
          });
      });
    }
  </script>

  <!-- Inicializa√ß√£o controlada -->
  <script>
    console.log('üöÄ BGAPP Fresh - Inicializa√ß√£o Controlada');
    
    // Estado global da aplica√ß√£o
    let appState = {
      occLayer: null,
      velocityLayer: null,
      wmsLayers: {},
      activeLayers: new Set(),
      isAnimating: false,
      panelCollapsed: false,
      eoxEnabled: true, // Flag para controlar EOX
      eoxErrorCount: 0,  // Contador de erros EOX
      stamenEnabled: true, // Flag para controlar Stamen
      stamenErrorCount: 0  // Contador de erros Stamen
    };

    // Vari√°veis globais para componentes
    let eoxManager = null;
    let gebcoManager = null;
    let map = null; // Inst√¢ncia global do mapa

    // API Base
    const apiBase = location.hostname === 'localhost' ? 'http://localhost:5080' : '/api';

    // Aguardar DOM estar pronto
    document.addEventListener('DOMContentLoaded', function() {
      console.log('‚úÖ DOM Ready - Iniciando sistema BGAPP');
      
      // Configurar mapa SIMPLES primeiro - sem TimeDimension
      map = L.map('map', {
        center: [-12.5, 13.5],
        zoom: 6,
        zoomControl: true,
        attributionControl: true
      });
      
      // Tornar mapa acess√≠vel globalmente
      window.map = map;

      console.log('‚úÖ Mapa Leaflet criado');

      // Adicionar OpenStreetMap IMEDIATAMENTE
      const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19,
        crossOrigin: true
      });
      osmLayer.addTo(map);
      console.log('‚úÖ OpenStreetMap adicionado imediatamente');

      // Aguardar um pouco e ent√£o inicializar componentes
      setTimeout(() => {
        initializeComponents(map);
      }, 1000);

      // Aguardar mais um pouco e ent√£o configurar event listeners
      setTimeout(() => {
        initializeEventListeners(map);
      }, 1500);
    });

    function initializeComponents(map) {
      console.log('üß© Inicializando componentes...');
      
      try {
        // Adicionar ZEE Angola
        if (typeof angolaZEEOfficial !== 'undefined') {
          L.polygon(angolaZEEOfficial, {
            color: '#0066cc',
            weight: 2,
            fillOpacity: 0.15,
            fillColor: '#0080ff',
            opacity: 0.7
          }).addTo(map).bindPopup('üåä ZEE Angola - OFICIAL<br>üìè 495.866 km¬≤ (Marine Regions)');
          
          console.log('‚úÖ ZEE Angola adicionada');
        }

        // ZEE Cabinda
        if (typeof cabindaZEEOfficial !== 'undefined') {
          L.polygon(cabindaZEEOfficial, {
            color: '#9b59b6',
            weight: 2,
            fillOpacity: 0.15,
            fillColor: '#9b59b6',
            opacity: 0.7
          }).addTo(map).bindPopup('üèõÔ∏è ZEE Cabinda - OFICIAL<br>üìç Marine Regions');
          
          console.log('‚úÖ ZEE Cabinda adicionada');
        }

        // EOX Layers Manager - SISTEMA ROBUSTO COM FALLBACK AUTOM√ÅTICO
        setTimeout(() => {
          try {
            if (typeof EOXLayersManager !== 'undefined') {
              console.log('üîß Inicializando EOX Manager com fallback robusto...');
              
              eoxManager = new EOXLayersManager(); // Tornar global
              
              // Configurar rate limiting mais agressivo
              eoxManager.setupRateLimiting();
              
              // Sistema de verifica√ß√£o de sa√∫de do EOX com m√∫ltiplas tentativas
              const checkEOXHealth = async () => {
                const testUrls = [
                  'https://tiles.maps.eox.at/wms?service=WMS&request=GetCapabilities&version=1.3.0',
                  'https://tiles.maps.eox.at/wms?service=WMS&request=GetMap&layers=terrain_3857&bbox=0,0,1,1&width=1&height=1&srs=EPSG:3857&format=image/png',
                  'https://www.gebco.net/data_and_products/gebco_web_services/web_map_service/mapserv?service=WMS&request=GetCapabilities'
                ];
                
                for (const url of testUrls) {
                  try {
                    const response = await fetch(url, {
                    method: 'GET',
                      signal: AbortSignal.timeout(2000) // Timeout ainda mais curto
                  });
                  
                    if (response.ok || response.status === 400) { // 400 pode ser v√°lido para WMS mal formado
                      console.log(`‚úÖ EOX/GEBCO Service parcialmente acess√≠vel via: ${url.split('?')[0]}`);
                    return true;
                  }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Teste falhou para ${url.split('?')[0]}:`, error.message);
                    continue;
                }
                }
                
                console.warn('‚ö†Ô∏è Todos os servi√ßos EOX/GEBCO inacess√≠veis');
                return false;
              };
              
              // Inicializar com verifica√ß√£o de sa√∫de e detec√ß√£o inteligente
              checkEOXHealth().then(isHealthy => {
                if (isHealthy) {
                  console.log('üöÄ Inicializando EOX Manager...');
                  eoxManager.createLayerControl(map);
                  
                  // Configurar fallback autom√°tico para camadas problem√°ticas
                  setTimeout(() => {
                    setupEOXFallback(map);
                  }, 2000);
                  
                  // Inicializar sistema de detec√ß√£o proativa de camadas
                  setTimeout(() => {
                    initializeLayerHealthMonitoring(map);
                  }, 5000);
                  
                } else {
                  console.log('üîÑ EOX indispon√≠vel - usando apenas camadas est√°veis');
                  setupStableLayersOnly(map);
                }
              });
              
            } else {
              console.warn('‚ö†Ô∏è EOXLayersManager n√£o dispon√≠vel - usando camadas b√°sicas');
              setupStableLayersOnly(map);
            }
          } catch (eoxError) {
            console.error('‚ùå Erro cr√≠tico no EOX Manager:', eoxError);
            setupStableLayersOnly(map);
          }
        }, 2000);

        // Inicializar dados batim√©tricos via EOX Terrain Light (solu√ß√£o CORS-free)
        setTimeout(async () => {
          console.log('üåä Inicializando dados batim√©tricos via EOX Terrain Light...');
          
          try {
            // Verificar se EOX Terrain Light est√° dispon√≠vel
            const eoxTerrainHealthy = await checkEOXTerrainLightHealth();
            
            if (eoxTerrainHealthy) {
              // Criar camada batim√©trica usando EOX Terrain (corrigido) - OTIMIZADA
              const bathymetryLayer = L.tileLayer.wms('https://tiles.maps.eox.at/wms', {
                layers: 'terrain_3857', // Nome correto baseado nos logs de sucesso
                format: 'image/jpeg', // EOX usa JPEG para terrain (conforme documenta√ß√£o)
                transparent: false,
                opacity: 0.8,
                attribution: 'üåä Batimetria: Terrain EOX (inclui GEBCO) ¬© EOX',
                maxZoom: 12,
                minZoom: 3,
                // Configura√ß√µes WMS corretas para EOX
                version: '1.3.0', // Vers√£o padr√£o WMS
                crs: L.CRS.EPSG3857,
                // Remover bounds restritivos que podem causar 400
                // bounds: L.latLngBounds([-18, 8], [-4, 18]) // Comentado - pode causar problemas
              });
              
              // Adicionar controle para ativar/desativar batimetria
              const bathymetryControl = L.control({ position: 'topright' });
              bathymetryControl.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                div.innerHTML = `
                  <a href="#" id="bathymetry-toggle" title="Toggle Batimetria GEBCO via EOX" 
                     style="background: #0066cc; color: white; padding: 8px; text-decoration: none; display: block;">
                    üåä Batimetria
                  </a>
                `;
                
                L.DomEvent.on(div.querySelector('#bathymetry-toggle'), 'click', function(e) {
                  e.preventDefault();
                  
                  if (map.hasLayer(bathymetryLayer)) {
                    map.removeLayer(bathymetryLayer);
                    this.style.background = '#666';
                    console.log('üåä Batimetria GEBCO (via EOX) desativada');
                  } else {
                    bathymetryLayer.addTo(map);
                    this.style.background = '#0066cc';
                    console.log('üåä Batimetria GEBCO (via EOX) ativada');
                  }
                });
                
                return div;
              };
              
              bathymetryControl.addTo(map);
              
              console.log('‚úÖ Sistema de batimetria EOX Terrain configurado com sucesso');
              console.log('üí° Usando terrain_3857 (corrigido) ao inv√©s de terrain-light');
              
              // Teste automatizado das corre√ß√µes
              setTimeout(() => {
                testCorrectedLayers(map);
              }, 2000);
              
            } else {
              console.warn('‚ö†Ô∏è EOX Terrain indispon√≠vel - tentando alternativas...');
              await setupBathymetryFallback(map);
            }
            
          } catch (error) {
            console.warn('‚ö†Ô∏è Erro ao configurar batimetria via EOX:', error);
          }
        }, 3000);

      } catch (error) {
        console.error('‚ùå Erro ao inicializar componentes:', error);
      }
    }

    function initializeEventListeners(map) {
      console.log('üéõÔ∏è Inicializando event listeners...');
      
      try {
        // Verificar se todos os elementos existem
        const elements = {
          apply: document.getElementById('apply'),
          dateMin: document.getElementById('dateMin'),
          btnSst: document.getElementById('btn-sst'),
          btnSalinity: document.getElementById('btn-salinity'),
          btnChlorophyll: document.getElementById('btn-chlorophyll'),
          btnCurrents: document.getElementById('btn-currents'),
          btnWind: document.getElementById('btn-wind'),
          btnClear: document.getElementById('btn-clear'),
          btnAnimate: document.getElementById('btn-animate'),
          btnDisableEox: document.getElementById('btn-disable-eox')
        };

        // Verificar elementos
        for (const [name, element] of Object.entries(elements)) {
          if (!element) {
            console.warn(`‚ö†Ô∏è Elemento ${name} n√£o encontrado`);
          } else {
            console.log(`‚úÖ Elemento ${name} encontrado`);
          }
        }

        // Configurar toggle do painel
        const panelToggle = document.getElementById('panel-toggle');
        const floatingToggle = document.getElementById('floating-toggle');
        
        if (panelToggle) {
          panelToggle.addEventListener('click', () => {
            togglePanel();
          });
        }
        
        if (floatingToggle) {
          floatingToggle.addEventListener('click', () => {
            togglePanel();
          });
        }

        // Configurar event listeners apenas para elementos que existem
        if (elements.apply) {
          elements.apply.addEventListener('click', () => {
            const date = elements.dateMin ? elements.dateMin.value : null;
            console.log('üìÖ Filtro de data aplicado:', date);
          });
          console.log('‚úÖ Event listener Apply configurado');
        }

        if (elements.btnSst) {
          elements.btnSst.addEventListener('click', (e) => {
            e.target.classList.toggle('active');
            e.target.setAttribute('aria-pressed', e.target.classList.contains('active'));
            console.log('üå°Ô∏è SST toggled:', e.target.classList.contains('active'));
          });
          console.log('‚úÖ Event listener SST configurado');
        }

        if (elements.btnSalinity) {
          elements.btnSalinity.addEventListener('click', (e) => {
            e.target.classList.toggle('active');
            e.target.setAttribute('aria-pressed', e.target.classList.contains('active'));
            console.log('üßÇ Salinidade toggled:', e.target.classList.contains('active'));
          });
          console.log('‚úÖ Event listener Salinidade configurado');
        }

        if (elements.btnChlorophyll) {
          elements.btnChlorophyll.addEventListener('click', (e) => {
            e.target.classList.toggle('active');
            e.target.setAttribute('aria-pressed', e.target.classList.contains('active'));
            console.log('üåø Clorofila toggled:', e.target.classList.contains('active'));
          });
          console.log('‚úÖ Event listener Clorofila configurado');
        }

        if (elements.btnCurrents) {
          elements.btnCurrents.addEventListener('click', (e) => {
            e.target.classList.toggle('active');
            e.target.setAttribute('aria-pressed', e.target.classList.contains('active'));
            console.log('üåä Correntes toggled:', e.target.classList.contains('active'));
          });
          console.log('‚úÖ Event listener Correntes configurado');
        }

        if (elements.btnWind) {
          elements.btnWind.addEventListener('click', (e) => {
            e.target.classList.toggle('active');
            e.target.setAttribute('aria-pressed', e.target.classList.contains('active'));
            console.log('üí® Vento toggled:', e.target.classList.contains('active'));
          });
          console.log('‚úÖ Event listener Vento configurado');
        }

        if (elements.btnClear) {
          elements.btnClear.addEventListener('click', () => {
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.btn.active').forEach(btn => {
              btn.classList.remove('active');
              btn.setAttribute('aria-pressed', 'false');
            });
            console.log('üóëÔ∏è Todas as camadas limpas');
          });
          console.log('‚úÖ Event listener Limpar configurado');
        }

        if (elements.btnAnimate) {
          elements.btnAnimate.addEventListener('click', (e) => {
            e.target.classList.toggle('active');
            const isActive = e.target.classList.contains('active');
            e.target.setAttribute('aria-pressed', isActive);
            
            const icon = document.getElementById('animate-icon');
            const text = document.getElementById('animate-text');
            
            if (isActive) {
              if (icon) icon.textContent = '‚è∏Ô∏è';
              if (text) text.textContent = 'Pausar';
              console.log('‚ñ∂Ô∏è Anima√ß√£o iniciada');
            } else {
              if (icon) icon.textContent = '‚ñ∂Ô∏è';
              if (text) text.textContent = 'Animar';
              console.log('‚è∏Ô∏è Anima√ß√£o pausada');
            }
          });
          console.log('‚úÖ Event listener Animar configurado');
        }

        if (elements.btnDisableEox) {
          elements.btnDisableEox.addEventListener('click', () => {
            appState.eoxEnabled = false;
            console.log('üö´ EOX desabilitado manualmente pelo usu√°rio');
            
            // For√ßar volta para OpenStreetMap
            const osmBtn = document.querySelector('[data-layer="osm"]');
            if (osmBtn) {
              osmBtn.click();
            }
            
            // Atualizar bot√£o
            elements.btnDisableEox.style.background = '#666';
            elements.btnDisableEox.innerHTML = '<span>‚úÖ</span> EOX OFF';
            elements.btnDisableEox.disabled = true;
            
            showEOXDisabledNotification();
          });
          console.log('‚úÖ Event listener EOX OFF configurado');
        }

        console.log('üéØ Todos os event listeners configurados com sucesso!');
        
        // Verificar status do mapa
        verifyMapStatus(map);
        
        // Adicionar marcador de teste para confirmar funcionamento
        setTimeout(() => {
          const testMarker = L.marker([-12.5, 13.5]).addTo(map);
          testMarker.bindPopup('üéâ MAPA FUNCIONANDO!<br>‚úÖ Corre√ß√µes aplicadas com sucesso');
          console.log('üìç Marcador de teste adicionado');
        }, 2000);

      } catch (error) {
        console.error('‚ùå Erro ao configurar event listeners:', error);
      }
    }

    // Fun√ß√£o simples para verificar se o mapa est√° funcionando
    function verifyMapStatus(map) {
      setTimeout(() => {
        console.log('üîç Verificando status do mapa...');
        
        const mapContainer = map.getContainer();
        const tiles = mapContainer.querySelectorAll('.leaflet-tile');
        
        console.log(`üìä Status: ${tiles.length} tiles encontradas`);
        
        // Atualizar status na interface
        const systemStatus = document.getElementById('system-status');
        if (systemStatus) {
          if (tiles.length > 0) {
            systemStatus.textContent = 'Sistema Online - Mapa Funcionando';
            systemStatus.style.color = '#27ae60';
          } else {
            systemStatus.textContent = 'Sistema Online - Carregando Mapa';
            systemStatus.style.color = '#f39c12';
          }
        }
      }, 3000);
    }

    // Fun√ß√£o para toggle do painel
    function togglePanel() {
      const toolbar = document.getElementById('toolbar');
      const floatingToggle = document.getElementById('floating-toggle');
      const panelToggle = document.getElementById('panel-toggle');
      
      appState.panelCollapsed = !appState.panelCollapsed;
      
      if (appState.panelCollapsed) {
        toolbar.classList.add('collapsed');
        floatingToggle.classList.add('show');
        if (panelToggle) {
          panelToggle.innerHTML = '<span>‚Üí</span>';
          panelToggle.setAttribute('aria-label', 'Expandir painel');
        }
        console.log('üì± Painel recolhido - mapa em tela cheia');
      } else {
        toolbar.classList.remove('collapsed');
        floatingToggle.classList.remove('show');
        if (panelToggle) {
          panelToggle.innerHTML = '<span>‚Üê</span>';
          panelToggle.setAttribute('aria-label', 'Recolher painel');
        }
        console.log('üì± Painel expandido');
      }
      
      // Invalidar tamanho do mapa ap√≥s anima√ß√£o
      setTimeout(() => {
        // Procurar inst√¢ncia do mapa no escopo global ou DOM
        const mapInstance = window.map || document.querySelector('#map')?._leaflet_map;
        if (mapInstance && typeof mapInstance.invalidateSize === 'function') {
          mapInstance.invalidateSize();
          console.log('‚úÖ Tamanho do mapa invalidado ap√≥s toggle do painel');
        } else {
          console.warn('‚ö†Ô∏è Inst√¢ncia do mapa n√£o encontrada para invalidateSize');
        }
      }, 300);
    }

    // Atalhos de teclado
    document.addEventListener('keydown', (e) => {
      // N√£o ativar se estiver digitando em um input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        return;
      }
      
      switch(e.key.toLowerCase()) {
        case ' ':
          e.preventDefault();
          togglePanel();
          break;
        case 'h':
          showHelp();
          break;
        case 'escape':
          if (!appState.panelCollapsed) {
            togglePanel();
          }
          break;
        case '1':
          document.getElementById('btn-sst')?.click();
          break;
        case '2':
          document.getElementById('btn-salinity')?.click();
          break;
        case '3':
          document.getElementById('btn-chlorophyll')?.click();
          break;
        case '4':
          document.getElementById('btn-currents')?.click();
          break;
        case '5':
          document.getElementById('btn-wind')?.click();
          break;
        case 'c':
          document.getElementById('btn-clear')?.click();
          break;
      }
    });

    function showHelp() {
      const helpText = `üéπ Atalhos de Teclado BGAPP:

üì± Painel:
‚Ä¢ Espa√ßo - Recolher/Expandir painel
‚Ä¢ Esc - Fechar painel
‚Ä¢ H - Mostrar esta ajuda

üåä Vari√°veis:
‚Ä¢ 1 - SST (Temperatura)
‚Ä¢ 2 - Salinidade  
‚Ä¢ 3 - Clorofila
‚Ä¢ 4 - Correntes
‚Ä¢ 5 - Vento
‚Ä¢ C - Limpar tudo

üñ±Ô∏è Mapa:
‚Ä¢ Arrastar - Navegar
‚Ä¢ Scroll - Zoom
‚Ä¢ Clique - Informa√ß√µes`;
      
      alert(helpText);
    }

    // Fun√ß√£o para configurar apenas camadas est√°veis
    function setupStableLayersOnly(map) {
      console.log('üõ°Ô∏è Configurando apenas camadas est√°veis...');
      
      // Criar controle de camadas b√°sico apenas com camadas que funcionam
      const stableLayers = {
        'OpenStreetMap': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors',
          maxZoom: 19
        }),
        'CartoDB Light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap, ¬© CartoDB',
          maxZoom: 19
        }),
        'CartoDB Dark': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap, ¬© CartoDB',
          maxZoom: 19
        }),
        'ESRI Satellite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: '¬© Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, and the GIS User Community',
          maxZoom: 18
        })
      };
      
      // Adicionar controle de camadas
      const layerControl = L.control.layers(stableLayers, {}, {
        position: 'topright',
        collapsed: false
      }).addTo(map);
      
      // Ativar OpenStreetMap por padr√£o
      stableLayers['OpenStreetMap'].addTo(map);
      
      console.log('‚úÖ Sistema funcionando com camadas est√°veis apenas');
    }
    
    // Fun√ß√£o para configurar fallback autom√°tico do EOX
    function setupEOXFallback(map) {
      console.log('üîß Configurando fallback autom√°tico para EOX...');
      
      // Verificar se eoxManager est√° dispon√≠vel e aplicar corre√ß√µes
      if (typeof eoxManager !== 'undefined' && eoxManager) {
        console.log('üîß Aplicando corre√ß√µes EOX Maps...');
        
        // Ativar terrain-light corrigido como padr√£o
        try {
          eoxManager.setBackgroundLayer(map, 'terrain-light');
          console.log('‚úÖ Terrain Light corrigido ativado');
          
          // Adicionar overlay coastline para Angola (muito √∫til para √°reas costeiras)
          setTimeout(() => {
            if (eoxManager.overlayLayers['coastline']) {
              eoxManager.overlayLayers['coastline'].addTo(map);
              console.log('‚úÖ Coastline overlay adicionado para Angola');
            }
          }, 1000);
          
        } catch (error) {
          console.warn('‚ö†Ô∏è Erro ao aplicar corre√ß√µes EOX, usando fallback:', error);
          // For√ßar uso de OpenStreetMap como padr√£o seguro
          const osmBtn = document.querySelector('[data-layer="osm"]');
          if (osmBtn && !osmBtn.classList.contains('active')) {
            osmBtn.click();
            console.log('üîÑ Ativado fallback seguro: OpenStreetMap');
          }
        }
      } else {
        // For√ßar uso de OpenStreetMap como padr√£o seguro IMEDIATAMENTE
        const osmBtn = document.querySelector('[data-layer="osm"]');
        if (osmBtn && !osmBtn.classList.contains('active')) {
          osmBtn.click();
          console.log('üîÑ Ativado fallback seguro IMEDIATO: OpenStreetMap');
        }
      }
      
      // Monitorar erros e fazer fallback autom√°tico mais agressivo
      let errorCount = 0;
      const maxErrors = 3; // Reduzido para reagir mais r√°pido
      let fallbackActivated = false;
      
      const errorHandler = (e) => {
        if (e.target && e.target.src && e.target.src.includes('tiles.maps.eox.at')) {
          errorCount++;
          console.warn(`‚ö†Ô∏è EOX Error #${errorCount}: ${e.target.src.substring(0, 80)}...`);
          
          if (errorCount >= maxErrors && !fallbackActivated) {
            fallbackActivated = true;
            console.error('‚ùå EOX inst√°vel detectado - Ativando fallback definitivo');
            
            // Desativar TODAS as camadas EOX imediatamente
            setTimeout(() => {
              const eoxButtons = document.querySelectorAll('[data-layer*="terrain"], [data-layer*="sentinel"], [data-layer*="black-marble"], [data-layer*="blue-marble"], [data-layer*="bathymetry"]');
              eoxButtons.forEach(btn => {
                if (btn.classList.contains('active')) {
                  btn.classList.remove('active');
                }
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.filter = 'grayscale(100%)';
                btn.title = 'üö´ Servi√ßo EOX indispon√≠vel - Use camadas alternativas';
              });
              
              // Garantir que OpenStreetMap est√° ativo
              const osmBtn = document.querySelector('[data-layer="osm"]');
              if (osmBtn && !osmBtn.classList.contains('active')) {
                osmBtn.click();
                console.log('üîÑ Fallback definitivo para OpenStreetMap');
              }
              
              showEOXDisabledNotification();
              
              // Atualizar estado global
              appState.eoxEnabled = false;
              
            }, 100);
            
            // Remover listener para evitar spam
            window.removeEventListener('error', errorHandler, true);
          }
        }
      };
      
      window.addEventListener('error', errorHandler, true);
      
      // Sistema de rate limiting inteligente e cache (otimizado para m√∫ltiplos servi√ßos)
      let requestStats = {
        eox: { count: 0, lastReset: Date.now(), blocked: false },
        gebco: { count: 0, lastReset: Date.now(), blocked: false },
        esri: { count: 0, lastReset: Date.now(), blocked: false },
        stamen: { count: 0, lastReset: Date.now(), blocked: false }
      };
      
      const RATE_LIMITS = {
        eox: { maxRequests: 40, windowMs: 10000 },    // 40 requests per 10s (aumentado para EOX)
        gebco: { maxRequests: 20, windowMs: 10000 },  // 20 requests per 10s
        esri: { maxRequests: 50, windowMs: 10000 },   // 50 requests per 10s (ESRI √© mais tolerante)
        stamen: { maxRequests: 25, windowMs: 10000 }  // 25 requests per 10s (Stamen pode ser inst√°vel)
      };
      
      // Cache inteligente para tiles com prioridade para batimetria
      const tileCache = new Map();
      const MAX_CACHE_SIZE = 200; // Aumentado para acomodar m√∫ltiplos servi√ßos
      const BATHYMETRY_CACHE_PRIORITY = 0.7; // 70% do cache reservado para batimetria
      
      // Fun√ß√£o para gerenciar cache com prioridade
      function manageTileCache(url, response, serviceType) {
        if (tileCache.size >= MAX_CACHE_SIZE) {
          // Se cache est√° cheio, remover tiles n√£o-batim√©tricos primeiro
          const toRemove = [];
          let removedCount = 0;
          const targetRemoval = Math.floor(MAX_CACHE_SIZE * 0.2); // Remover 20% do cache
          
          for (const [cachedUrl, cachedData] of tileCache.entries()) {
            if (!cachedUrl.includes('terrain') && !cachedUrl.includes('bathymetry') && removedCount < targetRemoval) {
              toRemove.push(cachedUrl);
              removedCount++;
            }
          }
          
          // Se n√£o encontrou tiles n√£o-batim√©tricos suficientes, remover os mais antigos
          if (removedCount < targetRemoval) {
            const entries = Array.from(tileCache.entries());
            const oldEntries = entries.slice(0, targetRemoval - removedCount);
            toRemove.push(...oldEntries.map(([url]) => url));
          }
          
          toRemove.forEach(url => tileCache.delete(url));
          console.log(`üßπ Cache limpo: ${toRemove.length} tiles removidas`);
        }
        
        tileCache.set(url, {
          response: response.clone(),
          timestamp: Date.now(),
          serviceType: serviceType,
          priority: (url.includes('terrain') || url.includes('bathymetry')) ? 'high' : 'normal'
        });
        
        console.log(`üíæ Tile cacheada (${serviceType}): ${tileCache.size}/${MAX_CACHE_SIZE}`);
      }
      
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        const url = args[0];
        
        if (typeof url === 'string') {
          let serviceType = null;
          
          if (url.includes('tiles.maps.eox.at')) {
            serviceType = 'eox';
          } else if (url.includes('gebco.net')) {
            serviceType = 'gebco';
          } else if (url.includes('arcgisonline.com')) {
            serviceType = 'esri';
          } else if (url.includes('stamen-tiles') || url.includes('tile.stamen.com') || url.includes('tiles.stadiamaps.com')) {
            serviceType = 'stamen';
          }
          
          if (serviceType) {
            const now = Date.now();
            const stats = requestStats[serviceType];
            const limits = RATE_LIMITS[serviceType];
            
            // Reset contador se janela de tempo passou
            if (now - stats.lastReset > limits.windowMs) {
              stats.count = 0;
              stats.lastReset = now;
              stats.blocked = false;
            }
            
            // Verificar rate limit
            if (stats.count >= limits.maxRequests) {
              if (!stats.blocked) {
                console.warn(`‚ö†Ô∏è Rate limit atingido para ${serviceType.toUpperCase()} - Aplicando throttling`);
                stats.blocked = true;
              }
              
              // Retornar Promise rejeitada para for√ßar fallback
              return Promise.reject(new Error(`Rate limit exceeded for ${serviceType}`));
            }
            
            stats.count++;
            
            // Verificar cache primeiro (para tiles de imagem) - sistema otimizado
            if (url.includes('GetMap') && tileCache.has(url)) {
              const cachedData = tileCache.get(url);
              const cacheAge = Date.now() - cachedData.timestamp;
              const maxAge = cachedData.priority === 'high' ? 3600000 : 1800000; // 1h para batimetria, 30min para outros
              
              if (cacheAge < maxAge) {
                console.log(`üéØ Cache hit para ${serviceType} (${Math.round(cacheAge/1000)}s): ${url.substring(0, 80)}...`);
                return Promise.resolve(cachedData.response);
              } else {
                console.log(`‚è∞ Cache expirado para ${serviceType}, removendo...`);
                tileCache.delete(url);
              }
            }
            
            // Filtrar requisi√ß√µes para camadas conhecidas como problem√°ticas
            if (url.includes('bathymetry') && serviceType === 'eox') {
              console.warn('üö´ Requisi√ß√£o bathymetry bloqueada (404 conhecido)');
              return Promise.reject(new Error('Bathymetry layer disabled due to 404'));
            }
            
            if (serviceType === 'gebco') {
              console.warn('üö´ Requisi√ß√£o GEBCO bloqueada (CORS conhecido)');
              return Promise.reject(new Error('GEBCO service disabled due to CORS'));
            }
            
            // Verificar se Stamen est√° com muitos erros 503
            if (serviceType === 'stamen' && appState.stamenErrorCount > 10) {
              console.warn('üö´ Requisi√ß√µes Stamen bloqueadas (muitos erros 503)');
              return Promise.reject(new Error('Stamen service disabled due to 503 errors'));
            }
            
            // Otimiza√ß√£o espec√≠fica para EOX: corrigir par√¢metros WMS problem√°ticos
            if (serviceType === 'eox' && url.includes('terrain-light')) {
              console.log('üîß Corrigindo par√¢metros para terrain-light -> terrain_3857');
              const correctedUrl = url.replace('terrain-light', 'terrain_3857')
                                     .replace('version=1.3.0', 'version=1.1.1');
              args[0] = correctedUrl;
            }
            
            // Fazer requisi√ß√£o com timeout otimizado
            const timeoutMs = serviceType === 'eox' ? 5000 : 8000; // EOX mais r√°pido
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
            
            args[1] = { ...(args[1] || {}), signal: controller.signal };
            
            return originalFetch.apply(this, args)
              .then(response => {
                clearTimeout(timeoutId);
                
                // An√°lise inteligente da resposta com cache otimizado
                if (response.ok) {
                  // Cachear resposta se for tile de imagem e bem-sucedida
                  if (url.includes('GetMap')) {
                    manageTileCache(url, response, serviceType);
                  }
                  return response;
                } else if (response.status === 400) {
                  console.error(`‚ùå 400 Bad Request para ${serviceType}`);
                  console.error(`üîç URL problem√°tica: ${url.substring(0, 150)}...`);
                  
                  // Diagn√≥stico espec√≠fico para EOX 400 errors
                  if (serviceType === 'eox') {
                    diagnosEOXError(url);
                  }
                  
                  return response;
                } else if (response.status === 404) {
                  console.warn(`‚ùå 404 para ${serviceType} - camada pode estar indispon√≠vel`);
                  return response;
                } else if (response.status === 503) {
                  console.error(`‚ùå 503 Service Unavailable para ${serviceType}`);
                  
                  // Tratamento espec√≠fico para Stamen 503
                  if (serviceType === 'stamen') {
                    appState.stamenErrorCount++;
                    console.warn(`‚ö†Ô∏è Stamen 503 Error #${appState.stamenErrorCount}`);
                    
                    if (appState.stamenErrorCount > 10 && appState.stamenEnabled) {
                      console.error('‚ùå Muitos erros 503 Stamen - Desabilitando servi√ßo');
                      appState.stamenEnabled = false;
                      showStamenDisabledNotification();
                    }
                  }
                  
                  return response;
                } else {
                  console.warn(`‚ö†Ô∏è Status ${response.status} para ${serviceType}`);
                  return response;
                }
              })
              .catch(error => {
                clearTimeout(timeoutId);
                
                // Tratamento espec√≠fico por tipo de erro
                if (error.name === 'AbortError') {
                  console.warn(`‚è±Ô∏è Timeout em requisi√ß√£o ${serviceType} (${timeoutMs}ms)`);
                } else if (error.message.includes('CORS')) {
                  console.warn(`üö´ CORS bloqueado para ${serviceType}`);
                } else {
                  console.warn(`‚ùå Erro em requisi√ß√£o ${serviceType}: ${error.message}`);
                }
                
                throw error;
              });
          }
        }
        
        return originalFetch.apply(this, args);
      };
    }

    // Monitor de erros para todos os servi√ßos (vers√£o melhorada)
    function monitorEOXErrors() {
      let errorDetails = {
        eox: { count: 0, lastError: null },
        gebco: { count: 0, lastError: null },
        stamen: { count: 0, lastError: null }
      };
      
      // Interceptar erros de imagem (tiles WMS)
      window.addEventListener('error', (e) => {
        if (e.target && e.target.src) {
          let serviceType = null;
          
          if (e.target.src.includes('tiles.maps.eox.at')) {
            serviceType = 'eox';
          } else if (e.target.src.includes('gebco.net')) {
            serviceType = 'gebco';
          } else if (e.target.src.includes('stamen-tiles') || e.target.src.includes('tile.stamen.com') || e.target.src.includes('tiles.stadiamaps.com')) {
            serviceType = 'stamen';
          }
          
          if (serviceType) {
            errorDetails[serviceType].count++;
            errorDetails[serviceType].lastError = e.target.src;
            
            console.warn(`‚ö†Ô∏è ${serviceType.toUpperCase()} Error #${errorDetails[serviceType].count}: ${e.target.src.substring(0, 100)}...`);
            
            // An√°lise inteligente de erros
            analyzeAndHandleErrors(serviceType, errorDetails[serviceType]);
          }
        }
      }, true);
      
      // Fun√ß√£o para analisar padr√µes de erro
      function analyzeAndHandleErrors(serviceType, errorInfo) {
        // Se muitos erros em pouco tempo, desabilitar temporariamente
                    if (errorInfo.count > 5) {
              console.error(`‚ùå Muitos erros ${serviceType.toUpperCase()} - Implementando fallback inteligente`);
              
              if (serviceType === 'eox' && appState.eoxEnabled) {
                appState.eoxEnabled = false;
                
                // For√ßar volta para OpenStreetMap
                const osmBtn = document.querySelector('[data-layer="osm"]');
                if (osmBtn && !osmBtn.classList.contains('active')) {
                  osmBtn.click();
                  console.log('üîÑ Fallback autom√°tico para OpenStreetMap');
                }
                
                showServiceErrorNotification(serviceType, errorInfo.count);
              } else if (serviceType === 'stamen' && appState.stamenEnabled) {
                appState.stamenEnabled = false;
                appState.stamenErrorCount = errorInfo.count;
                
                // Tentar ativar EOX como fallback para Stamen
                const eoxBtn = document.querySelector('[data-layer*="terrain"]');
                if (eoxBtn && !eoxBtn.classList.contains('active')) {
                  console.log('üîÑ Fallback autom√°tico Stamen ‚Üí EOX');
                  eoxBtn.click();
                } else {
                  // Se EOX n√£o dispon√≠vel, usar OpenStreetMap
                  const osmBtn = document.querySelector('[data-layer="osm"]');
                  if (osmBtn && !osmBtn.classList.contains('active')) {
                    osmBtn.click();
                    console.log('üîÑ Fallback autom√°tico Stamen ‚Üí OpenStreetMap');
                  }
                }
                
                showStamenDisabledNotification();
              }
          
          // Reset contador ap√≥s um tempo para permitir retry
          setTimeout(() => {
            errorDetails[serviceType].count = Math.max(0, errorDetails[serviceType].count - 2);
          }, 30000); // 30 segundos
        }
      }
    }
    
    // Fun√ß√£o para verificar sa√∫de do EOX e validar camadas dispon√≠veis
    async function checkEOXTerrainLightHealth() {
      try {
        // Testar EOX WMS service
        const response = await fetch('https://tiles.maps.eox.at/wms?service=WMS&request=GetCapabilities&version=1.1.1', {
          method: 'GET',
          signal: AbortSignal.timeout(5000)
        });
        
        if (response.ok) {
          console.log('‚úÖ EOX WMS Service Online');
          
          // Validar camadas espec√≠ficas que sabemos que funcionam
          const workingLayers = ['terrain_3857', 'overlay_3857'];
          const validationPromises = workingLayers.map(async (layerName) => {
            try {
              // Teste m√≠nimo para cada camada
              const testUrl = `https://tiles.maps.eox.at/wms?service=WMS&request=GetMap&layers=${layerName}&bbox=0,0,1,1&width=1&height=1&srs=EPSG:3857&format=image/png&version=1.1.1`;
              const testResponse = await fetch(testUrl, { 
                method: 'GET', 
                signal: AbortSignal.timeout(3000) 
              });
              
              if (testResponse.ok || testResponse.status === 400) { // 400 pode ser bbox inv√°lido mas camada existe
                console.log(`‚úÖ Camada ${layerName} validada`);
                return { layer: layerName, available: true };
              } else {
                console.warn(`‚ö†Ô∏è Camada ${layerName} retornou ${testResponse.status}`);
                return { layer: layerName, available: false };
              }
            } catch (error) {
              console.warn(`‚ùå Erro ao validar ${layerName}:`, error.message);
              return { layer: layerName, available: false };
            }
          });
          
          const validationResults = await Promise.all(validationPromises);
          const availableLayers = validationResults.filter(r => r.available);
          
          console.log(`‚úÖ EOX Service Online - ${availableLayers.length}/${workingLayers.length} camadas dispon√≠veis`);
          return availableLayers.length > 0;
          
        } else {
          console.warn(`‚ö†Ô∏è EOX WMS retornou status ${response.status}`);
          return false;
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è EOX WMS inacess√≠vel:', error.message);
        return false;
      }
    }
    
    // Fun√ß√£o GEBCO original mantida para refer√™ncia (desabilitada)
    async function checkGEBCOHealth() {
      console.log('‚ÑπÔ∏è GEBCO direto desabilitado - usando EOX Terrain Light que inclui GEBCO');
      return false; // Sempre retorna false para for√ßar uso do EOX
    }
    
    // Sistema de fallback para dados batim√©tricos
    async function setupBathymetryFallback(map) {
      console.log('üîÑ Configurando sistema de fallback para batimetria...');
      
      const fallbackOptions = [
        {
          name: 'EOX Terrain',
          url: 'https://tiles.maps.eox.at/wms',
          layers: 'terrain_3857', // Nome correto baseado nos logs
          attribution: 'Terrain ¬© EOX, dados diversos incluindo GEBCO'
        },
        {
          name: 'ESRI Ocean Basemap',
          url: 'https://services.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}',
          type: 'xyz',
          attribution: 'Ocean Basemap ¬© Esri, GEBCO, NOAA, National Geographic'
        },
        {
          name: 'OpenStreetMap (sem batimetria)',
          url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
          type: 'xyz',
          attribution: '¬© OpenStreetMap contributors (fallback b√°sico)'
        }
      ];
      
      for (const option of fallbackOptions) {
        try {
          console.log(`üß™ Testando fallback: ${option.name}...`);
          
          let layer;
          if (option.type === 'xyz') {
            layer = L.tileLayer(option.url, {
              attribution: option.attribution,
              maxZoom: 18,
              opacity: 0.8
            });
          } else {
            // WMS layer com configura√ß√µes corretas para EOX
            layer = L.tileLayer.wms(option.url, {
              layers: option.layers,
              format: 'image/png',
              transparent: false,
              attribution: option.attribution,
              maxZoom: 12,
              opacity: 0.8,
              version: '1.1.1', // Vers√£o mais compat√≠vel
              crs: L.CRS.EPSG3857
            });
          }
          
          // Testar se a camada carrega
          const testPromise = new Promise((resolve, reject) => {
            const timeout = setTimeout(() => {
              reject(new Error('Timeout'));
            }, 5000);
            
            layer.on('load', () => {
              clearTimeout(timeout);
              resolve(true);
            });
            
            layer.on('tileerror', () => {
              clearTimeout(timeout);
              reject(new Error('Tile error'));
            });
          });
          
          // Adicionar temporariamente para teste
          layer.addTo(map);
          
          try {
            await testPromise;
            
            // Se chegou aqui, o fallback funciona
            console.log(`‚úÖ Fallback funcionando: ${option.name}`);
            
            // Criar controle para esta camada
            const fallbackControl = L.control({ position: 'topright' });
            fallbackControl.onAdd = function(map) {
              const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
              div.innerHTML = `
                <a href="#" id="bathymetry-fallback-toggle" title="Toggle ${option.name}" 
                   style="background: #ff6b35; color: white; padding: 8px; text-decoration: none; display: block; font-size: 11px;">
                  üåä ${option.name}
                </a>
              `;
              
              L.DomEvent.on(div.querySelector('#bathymetry-fallback-toggle'), 'click', function(e) {
                e.preventDefault();
                
                if (map.hasLayer(layer)) {
                  map.removeLayer(layer);
                  this.style.background = '#666';
                  console.log(`üåä ${option.name} desativado`);
                } else {
                  layer.addTo(map);
                  this.style.background = '#ff6b35';
                  console.log(`üåä ${option.name} ativado`);
                }
              });
              
              return div;
            };
            
            fallbackControl.addTo(map);
            
            // Notificar usu√°rio sobre o fallback
            showBathymetryFallbackNotification(option.name);
            
            return; // Sair do loop, encontramos um fallback funcional
            
          } catch (testError) {
            console.warn(`‚ùå Fallback ${option.name} falhou no teste:`, testError.message);
            map.removeLayer(layer); // Remover camada que falhou
            continue; // Tentar pr√≥ximo fallback
          }
          
        } catch (error) {
          console.warn(`‚ùå Erro ao configurar fallback ${option.name}:`, error);
          continue;
        }
      }
      
      console.warn('‚ùå Todos os fallbacks de batimetria falharam');
    }
    
    // Notifica√ß√£o para fallback de batimetria
    function showBathymetryFallbackNotification(fallbackName) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        bottom: 24px;
        left: 24px;
        background: rgba(255, 107, 53, 0.95);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
        z-index: 1500;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        max-width: 350px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      `;
      notification.innerHTML = `
        <div style="margin-bottom: 8px; font-size: 14px;">
          üîÑ Fallback Ativado
        </div>
        <div style="font-size: 12px; opacity: 0.9; line-height: 1.4;">
          <strong>Batimetria:</strong> ${fallbackName}<br>
          EOX Terrain Light indispon√≠vel, usando alternativa.
        </div>
      `;
      document.body.appendChild(notification);
      
      // Auto-remover ap√≥s 6 segundos
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(-20px)';
        setTimeout(() => notification.remove(), 300);
      }, 6000);
    }
    
    // Notifica√ß√£o espec√≠fica para Stamen desabilitado
    function showStamenDisabledNotification() {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, rgba(255, 59, 48, 0.95), rgba(255, 149, 0, 0.95));
        color: white;
        padding: 20px 28px;
        border-radius: 16px;
        font-size: 14px;
        font-weight: 500;
        z-index: 2000;
        backdrop-filter: blur(20px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        text-align: center;
        max-width: 380px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      `;
      notification.innerHTML = `
        <div style="margin-bottom: 12px; font-size: 16px;">
          üö´ Stamen Tiles Indispon√≠vel
        </div>
        <div style="font-size: 13px; line-height: 1.4; margin-bottom: 12px; opacity: 0.95;">
          Servi√ßo Stamen retornando <strong>503 Service Unavailable</strong>.<br>
          Camadas Stamen temporariamente desabilitadas.
        </div>
        <div style="font-size: 12px; background: rgba(255, 255, 255, 0.15); padding: 8px 12px; border-radius: 8px; margin-bottom: 8px;">
          ‚úÖ Fallback autom√°tico ativado<br>
          ‚úÖ EOX e outras camadas funcionando<br>
          üîÑ Retry autom√°tico em 5 minutos
        </div>
        <div style="font-size: 11px; opacity: 0.8;">
          Sistema funcionando com camadas alternativas
        </div>
      `;
      document.body.appendChild(notification);
      
      // Auto-fechar ap√≥s 6 segundos
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -50%) scale(0.9)';
        setTimeout(() => notification.remove(), 300);
      }, 6000);
      
      // Permitir fechar clicando
      notification.addEventListener('click', () => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -50%) scale(0.9)';
        setTimeout(() => notification.remove(), 300);
      });
      
      notification.style.cursor = 'pointer';
      
      // Programar retry autom√°tico em 5 minutos
      setTimeout(() => {
        console.log('üîÑ Tentando reabilitar Stamen ap√≥s 5 minutos...');
        appState.stamenErrorCount = 0;
        appState.stamenEnabled = true;
      }, 300000); // 5 minutos
    }
    
    // Notifica√ß√£o melhorada para erros de servi√ßo
    function showServiceErrorNotification(serviceType, errorCount) {
      const serviceNames = {
        'eox': 'EOX Maps',
        'gebco': 'GEBCO Bathymetry',
        'stamen': 'Stamen Tiles'
      };
      
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, rgba(255, 149, 0, 0.95), rgba(255, 59, 48, 0.95));
        color: white;
        padding: 20px 28px;
        border-radius: 16px;
        font-size: 14px;
        font-weight: 500;
        z-index: 2000;
        backdrop-filter: blur(20px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        text-align: center;
        max-width: 380px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      `;
      notification.innerHTML = `
        <div style="margin-bottom: 12px; font-size: 16px;">
          üõ°Ô∏è Sistema Adaptativo
        </div>
        <div style="font-size: 13px; line-height: 1.4; margin-bottom: 12px; opacity: 0.95;">
          Servi√ßo <strong>${serviceNames[serviceType]}</strong> inst√°vel detectado.<br>
          <strong>Erros registrados:</strong> ${errorCount}
        </div>
        <div style="font-size: 12px; background: rgba(255, 255, 255, 0.15); padding: 8px 12px; border-radius: 8px; margin-bottom: 8px;">
          ‚úÖ Fallback autom√°tico ativado<br>
          ‚úÖ Camadas est√°veis funcionando<br>
          üîÑ Retry autom√°tico em 30s
        </div>
        <div style="font-size: 11px; opacity: 0.8;">
          Sistema funcionando normalmente com camadas alternativas
        </div>
      `;
      document.body.appendChild(notification);
      
      // Auto-fechar ap√≥s 4 segundos
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -50%) scale(0.9)';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
      
      // Permitir fechar clicando
      notification.addEventListener('click', () => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -50%) scale(0.9)';
        setTimeout(() => notification.remove(), 300);
      });
      
      notification.style.cursor = 'pointer';
    }
    
    function showEOXDisabledNotification() {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, rgba(255, 149, 0, 0.95), rgba(255, 59, 48, 0.95));
        color: white;
        padding: 20px 28px;
        border-radius: 16px;
        font-size: 14px;
        font-weight: 500;
        z-index: 2000;
        backdrop-filter: blur(20px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        text-align: center;
        max-width: 380px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      `;
      notification.innerHTML = `
        <div style="margin-bottom: 12px; font-size: 16px;">
          üõ°Ô∏è Sistema Estabilizado
        </div>
        <div style="font-size: 13px; line-height: 1.4; margin-bottom: 12px; opacity: 0.95;">
          Servi√ßos EOX inst√°veis foram desabilitados.<br>
          <strong>Camadas funcionais dispon√≠veis:</strong>
        </div>
        <div style="font-size: 12px; background: rgba(255, 255, 255, 0.15); padding: 8px 12px; border-radius: 8px; margin-bottom: 8px;">
          ‚úÖ OpenStreetMap<br>
          ‚úÖ CartoDB Light & Dark<br>
          ‚úÖ ESRI Satellite
        </div>
        <div style="font-size: 11px; opacity: 0.8;">
          Sistema funcionando normalmente com camadas est√°veis
        </div>
      `;
      document.body.appendChild(notification);
      
      // Auto-fechar ap√≥s 5 segundos
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -50%) scale(0.9)';
        setTimeout(() => notification.remove(), 300);
      }, 5000);
      
      // Permitir fechar clicando
      notification.addEventListener('click', () => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -50%) scale(0.9)';
        setTimeout(() => notification.remove(), 300);
      });
      
      // Adicionar cursor pointer para indicar que √© clic√°vel
      notification.style.cursor = 'pointer';
    }
    
    // Fun√ß√£o de diagn√≥stico para erros EOX 400 Bad Request
    function diagnosEOXError(url) {
      console.group('üîß Diagn√≥stico EOX 400 Error');
      
      try {
        const urlObj = new URL(url);
        const params = new URLSearchParams(urlObj.search);
        
        console.log('üìã Par√¢metros da requisi√ß√£o:');
        for (const [key, value] of params.entries()) {
          console.log(`  ${key}: ${value}`);
        }
        
        // Verifica√ß√µes espec√≠ficas
        const layers = params.get('layers');
        const version = params.get('version');
        const bbox = params.get('bbox');
        const srs = params.get('srs');
        
        console.log('üîç An√°lise de problemas potenciais:');
        
        if (layers && layers.includes('terrain-light')) {
          console.warn('  ‚ö†Ô∏è Camada "terrain-light" pode estar incorreta - tentar "terrain_3857"');
        }
        
        if (version === '1.3.0') {
          console.warn('  ‚ö†Ô∏è Vers√£o 1.3.0 pode ser incompat√≠vel - tentar "1.1.1"');
        }
        
        if (bbox) {
          const bboxValues = bbox.split(',').map(Number);
          if (bboxValues.some(val => Math.abs(val) > 20037508)) {
            console.warn('  ‚ö†Ô∏è Bbox pode estar fora dos limites EPSG:3857');
          }
        }
        
        if (srs === 'EPSG:3857' && version === '1.3.0') {
          console.warn('  ‚ö†Ô∏è Combina√ß√£o EPSG:3857 + vers√£o 1.3.0 pode causar problemas');
        }
        
        // Sugest√µes de corre√ß√£o
        console.log('üí° Sugest√µes de corre√ß√£o:');
        console.log('  - Usar camada: terrain_3857 ou overlay_3857');
        console.log('  - Usar vers√£o: 1.1.1');
        console.log('  - Verificar bbox dentro dos limites v√°lidos');
        
      } catch (error) {
        console.error('‚ùå Erro no diagn√≥stico:', error);
      }
      
      console.groupEnd();
    }
    
    // Fun√ß√£o de teste automatizado para camadas corrigidas
    async function testCorrectedLayers(map) {
      console.group('üß™ Teste Automatizado de Camadas Corrigidas');
      
      const testResults = {
        terrain_3857: false,
        overlay_3857: false,
        errors: []
      };
      
      // Lista de testes a executar
      const tests = [
        {
          name: 'terrain_3857',
          url: 'https://tiles.maps.eox.at/wms?service=WMS&request=GetMap&layers=terrain_3857&bbox=1000000,-1000000,2000000,0&width=256&height=256&srs=EPSG:3857&format=image/png&version=1.1.1'
        },
        {
          name: 'overlay_3857',
          url: 'https://tiles.maps.eox.at/wms?service=WMS&request=GetMap&layers=overlay_3857&bbox=1000000,-1000000,2000000,0&width=256&height=256&srs=EPSG:3857&format=image/png&version=1.1.1'
        }
      ];
      
      console.log('üî¨ Executando testes de valida√ß√£o...');
      
      for (const test of tests) {
        try {
          console.log(`üß™ Testando ${test.name}...`);
          
          const startTime = Date.now();
          const response = await fetch(test.url, {
            method: 'GET',
            signal: AbortSignal.timeout(5000)
          });
          const endTime = Date.now();
          
          if (response.ok) {
            testResults[test.name] = true;
            console.log(`‚úÖ ${test.name}: OK (${response.status}) - ${endTime - startTime}ms`);
          } else {
            testResults.errors.push(`${test.name}: Status ${response.status}`);
            console.warn(`‚ùå ${test.name}: Status ${response.status}`);
            
            if (response.status === 400) {
              console.warn(`üîç Analisando erro 400 para ${test.name}...`);
              diagnosEOXError(test.url);
            }
          }
          
        } catch (error) {
          testResults.errors.push(`${test.name}: ${error.message}`);
          console.error(`‚ùå ${test.name}: ${error.message}`);
        }
      }
      
      // Relat√≥rio final
      const successCount = Object.values(testResults).filter(v => v === true).length;
      const totalTests = tests.length;
      
      console.log('üìä Relat√≥rio de Testes:');
      console.log(`  ‚úÖ Sucessos: ${successCount}/${totalTests}`);
      console.log(`  ‚ùå Erros: ${testResults.errors.length}`);
      
      if (testResults.errors.length > 0) {
        console.log('üìã Lista de Erros:');
        testResults.errors.forEach(error => console.log(`  - ${error}`));
      }
      
      // Notifica√ß√£o visual do resultado
      if (successCount === totalTests) {
        console.log('üéâ Todos os testes passaram! Camadas EOX funcionando corretamente.');
        showTestSuccessNotification();
      } else {
        console.warn(`‚ö†Ô∏è ${totalTests - successCount} teste(s) falharam. Sistema pode ter problemas.`);
        showTestWarningNotification(successCount, totalTests);
      }
      
      console.groupEnd();
      return testResults;
    }
    
    // Notifica√ß√µes de resultado dos testes
    function showTestSuccessNotification() {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        right: 24px;
        background: linear-gradient(135deg, rgba(52, 199, 89, 0.95), rgba(48, 176, 199, 0.95));
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
        z-index: 2000;
        backdrop-filter: blur(20px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        max-width: 300px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      `;
      notification.innerHTML = `
        <div style="margin-bottom: 8px; font-size: 14px;">
          üéâ Testes Aprovados
        </div>
        <div style="font-size: 12px; opacity: 0.9;">
          Todas as corre√ß√µes EOX funcionando!<br>
          Camadas terrain_3857 e overlay_3857 OK.
        </div>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(20px)';
        setTimeout(() => notification.remove(), 300);
      }, 4000);
    }
    
    function showTestWarningNotification(success, total) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        right: 24px;
        background: linear-gradient(135deg, rgba(255, 149, 0, 0.95), rgba(255, 59, 48, 0.95));
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
        z-index: 2000;
        backdrop-filter: blur(20px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        max-width: 300px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      `;
      notification.innerHTML = `
        <div style="margin-bottom: 8px; font-size: 14px;">
          ‚ö†Ô∏è Testes Parciais
        </div>
        <div style="font-size: 12px; opacity: 0.9;">
          ${success}/${total} camadas funcionando.<br>
          Verifique console para detalhes.
        </div>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(20px)';
        setTimeout(() => notification.remove(), 300);
      }, 6000);
    }
    
    // Sistema de monitoramento proativo de sa√∫de das camadas
    function initializeLayerHealthMonitoring(map) {
      console.log('üîç Inicializando monitoramento proativo de camadas...');
      
      const layerHealthStatus = new Map();
      const HEALTH_CHECK_INTERVAL = 60000; // 1 minuto
      const FAILURE_THRESHOLD = 3;
      
      // Lista de camadas cr√≠ticas para monitorar (apenas as que funcionam)
      const criticalLayers = [
        { name: 'terrain_3857', service: 'eox', url: 'https://tiles.maps.eox.at/wms' },
        { name: 'overlay_3857', service: 'eox', url: 'https://tiles.maps.eox.at/wms' }
        // Removidas temporariamente: bathymetry (404) e GEBCO (CORS)
      ];
      
      // Fun√ß√£o para testar sa√∫de de uma camada espec√≠fica
      async function testLayerHealth(layer) {
        // Usar GetCapabilities ao inv√©s de GetMap para evitar problemas de bbox
        const testParams = {
          service: 'WMS',
          request: 'GetCapabilities',
          version: '1.3.0'
        };
        
        const url = `${layer.url}?${new URLSearchParams(testParams).toString()}`;
        
        try {
          const response = await fetch(url, {
            method: 'GET',
            signal: AbortSignal.timeout(5000), // Timeout maior para GetCapabilities
            mode: 'cors' // Explicitamente permitir CORS
          });
          
          if (response.ok) {
            console.log(`‚úÖ Camada ${layer.name} est√° saud√°vel (${response.status})`);
            return true;
          } else {
            console.warn(`‚ö†Ô∏è Camada ${layer.name} retornou status ${response.status}`);
            return false;
          }
        } catch (error) {
          // An√°lise detalhada do tipo de erro
          if (error.name === 'TypeError' && error.message.includes('CORS')) {
            console.warn(`üö´ CORS bloqueado para ${layer.name} - servi√ßo pode estar funcionando mas inacess√≠vel via browser`);
            return false; // CORS = n√£o utiliz√°vel no browser
          } else if (error.name === 'AbortError') {
            console.warn(`‚è±Ô∏è Timeout para ${layer.name} - servi√ßo lento ou indispon√≠vel`);
            return false;
          } else {
            console.warn(`‚ùå Erro desconhecido para ${layer.name}:`, error.message);
            return false;
          }
        }
      }
      
      // Fun√ß√£o principal de verifica√ß√£o
      async function performHealthCheck() {
        console.log('üîç Executando verifica√ß√£o de sa√∫de das camadas...');
        
        for (const layer of criticalLayers) {
          const isHealthy = await testLayerHealth(layer);
          const currentStatus = layerHealthStatus.get(layer.name) || { failures: 0, lastHealthy: Date.now() };
          
          if (isHealthy) {
            // Reset contador de falhas se camada est√° saud√°vel
            layerHealthStatus.set(layer.name, { failures: 0, lastHealthy: Date.now() });
            console.log(`‚úÖ Camada ${layer.name} est√° saud√°vel`);
          } else {
            // Incrementar contador de falhas
            currentStatus.failures++;
            layerHealthStatus.set(layer.name, currentStatus);
            
            console.warn(`‚ùå Camada ${layer.name} falhou (${currentStatus.failures}/${FAILURE_THRESHOLD})`);
            
            // Se atingiu threshold, desabilitar camada
            if (currentStatus.failures >= FAILURE_THRESHOLD) {
              disableProblematicLayer(layer, map);
            }
          }
        }
        
        // Atualizar status na interface
        updateHealthStatusDisplay();
      }
      
      // Fun√ß√£o para desabilitar camada problem√°tica
      function disableProblematicLayer(layer, map) {
        console.error(`üö´ Desabilitando camada problem√°tica: ${layer.name}`);
        
        // Encontrar e desabilitar bot√µes relacionados
        const layerButtons = document.querySelectorAll(`[data-layer*="${layer.service}"]`);
        layerButtons.forEach(btn => {
          if (btn.classList.contains('active')) {
            btn.classList.remove('active');
          }
          btn.disabled = true;
          btn.style.opacity = '0.5';
          btn.title = `üö´ Camada ${layer.name} temporariamente indispon√≠vel`;
        });
        
        // Ativar fallback se necess√°rio
        if (layer.service === 'eox') {
          const osmBtn = document.querySelector('[data-layer="osm"]');
          if (osmBtn && !osmBtn.classList.contains('active')) {
            osmBtn.click();
            console.log('üîÑ Ativado fallback autom√°tico para OpenStreetMap');
          }
        }
        
        // Mostrar notifica√ß√£o
        showLayerDisabledNotification(layer.name);
      }
      
      // Fun√ß√£o para atualizar display de status
      function updateHealthStatusDisplay() {
        const systemStatus = document.getElementById('system-status');
        if (systemStatus) {
          const totalLayers = criticalLayers.length;
          const healthyLayers = Array.from(layerHealthStatus.values())
            .filter(status => status.failures === 0).length;
          
          if (healthyLayers === totalLayers) {
            systemStatus.textContent = 'Sistema Online - Todas as Camadas OK';
            systemStatus.style.color = '#27ae60';
          } else if (healthyLayers > totalLayers / 2) {
            systemStatus.textContent = `Sistema Online - ${healthyLayers}/${totalLayers} Camadas OK`;
            systemStatus.style.color = '#f39c12';
          } else {
            systemStatus.textContent = `Sistema Degradado - ${healthyLayers}/${totalLayers} Camadas OK`;
            systemStatus.style.color = '#e74c3c';
          }
        }
      }
      
      // Notifica√ß√£o para camada desabilitada
      function showLayerDisabledNotification(layerName) {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          bottom: 24px;
          right: 24px;
          background: rgba(231, 76, 60, 0.95);
          color: white;
          padding: 12px 20px;
          border-radius: 12px;
          font-size: 13px;
          font-weight: 500;
          z-index: 1500;
          backdrop-filter: blur(10px);
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
          max-width: 300px;
          border: 1px solid rgba(255, 255, 255, 0.2);
        `;
        notification.innerHTML = `
          <div style="margin-bottom: 6px; font-size: 14px;">
            üö´ Camada Desabilitada
          </div>
          <div style="font-size: 12px; opacity: 0.9;">
            <strong>${layerName}</strong> temporariamente indispon√≠vel.<br>
            Fallback autom√°tico ativado.
          </div>
        `;
        document.body.appendChild(notification);
        
        // Auto-remover ap√≥s 5 segundos
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(20px)';
          setTimeout(() => notification.remove(), 300);
        }, 5000);
      }
      
      // Executar primeira verifica√ß√£o ap√≥s 10 segundos
      setTimeout(performHealthCheck, 10000);
      
      // Configurar verifica√ß√µes peri√≥dicas
      setInterval(performHealthCheck, HEALTH_CHECK_INTERVAL);
      
      console.log('‚úÖ Sistema de monitoramento proativo configurado');
    }
    
    // Sistema de tratamento global de erros
    function setupGlobalErrorHandling() {
      // Capturar erros JavaScript n√£o tratados
      window.addEventListener('error', (event) => {
        console.error('üö® Erro JavaScript n√£o tratado:', {
          message: event.message,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          error: event.error
        });
        
        // Prevenir que erros de camadas quebrem a aplica√ß√£o
        if (event.message && (
          event.message.includes('invalidateSize') ||
          event.message.includes('EOX') ||
          event.message.includes('GEBCO') ||
          event.message.includes('WMS')
        )) {
          console.log('üõ°Ô∏è Erro de camada interceptado - aplica√ß√£o continua funcionando');
          event.preventDefault();
          return false;
        }
      });
      
      // Capturar promises rejeitadas n√£o tratadas
      window.addEventListener('unhandledrejection', (event) => {
        console.error('üö® Promise rejeitada n√£o tratada:', event.reason);
        
        // Prevenir que erros de rede quebrem a aplica√ß√£o
        if (event.reason && (
          event.reason.message?.includes('fetch') ||
          event.reason.message?.includes('CORS') ||
          event.reason.message?.includes('404') ||
          event.reason.message?.includes('Rate limit')
        )) {
          console.log('üõ°Ô∏è Erro de rede interceptado - aplica√ß√£o continua funcionando');
          event.preventDefault();
        }
      });
      
      console.log('‚úÖ Sistema de tratamento global de erros configurado');
    }
    
    // Inicializar tratamento de erros primeiro
    setupGlobalErrorHandling();

    // Inicializar monitor
    monitorEOXErrors();

    // Fun√ß√£o para habilitar visualiza√ß√£o 3D (placeholder)
    function enable3DView() {
      console.log('üéØ Fun√ß√£o 3D View chamada');
      
      // Mostrar notifica√ß√£o de recurso em desenvolvimento
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 122, 255, 0.95);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        z-index: 2000;
        backdrop-filter: blur(20px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        text-align: center;
        max-width: 300px;
      `;
      notification.innerHTML = `
        <div style="margin-bottom: 8px;">üöÄ Visualiza√ß√£o 3D</div>
        <div style="font-size: 12px; opacity: 0.9;">
          Recurso em desenvolvimento.<br>
          Aguarde futuras atualiza√ß√µes!
        </div>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translate(-50%, -50%) scale(0.9)';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }
    
    // Adicionar enable3DView ao escopo global
    window.enable3DView = enable3DView;

    // Mostrar hint de atalhos na inicializa√ß√£o
    setTimeout(() => {
      const hint = document.createElement('div');
      hint.style.cssText = `
        position: fixed;
        bottom: 24px;
        left: 24px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 12px;
        padding: 8px 16px;
        font-size: 11px;
        color: #666;
        z-index: 1000;
        border: 1px solid rgba(0, 0, 0, 0.1);
        animation: fadeInOut 4s ease-in-out;
      `;
      hint.textContent = 'Pressione H para atalhos ou Espa√ßo para recolher painel';
      document.body.appendChild(hint);
      
      setTimeout(() => {
        hint.remove();
      }, 4000);
    }, 2000);
  </script>
</body>
</html>
