<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ BGAPP - Teste Pyodide + Deck.GL Integration</title>
    
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    
    <!-- Deck.GL -->
    <script src="https://unpkg.com/deck.gl@9.1.14/dist.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .map-container {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .status-box {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }
        
        .status-ok { color: #4caf50; font-weight: bold; }
        .status-error { color: #f44336; font-weight: bold; }
        .status-loading { color: #ff9800; font-weight: bold; }
        
        .code-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: scale(1.05);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .metric {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
        }
        
        .metric-label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Teste de Integra√ß√£o Pyodide + Deck.GL para BGAPP</h1>
        
        <div class="test-grid">
            <!-- Painel de Status -->
            <div class="test-panel">
                <h2>üìä Status do Sistema</h2>
                <div class="status-box">
                    <div class="status-item">
                        <span>Pyodide</span>
                        <span id="pyodide-status" class="status-loading">Carregando...</span>
                    </div>
                    <div class="status-item">
                        <span>Deck.GL</span>
                        <span id="deckgl-status" class="status-loading">Verificando...</span>
                    </div>
                    <div class="status-item">
                        <span>Python ‚Üî JS Bridge</span>
                        <span id="bridge-status" class="status-loading">Aguardando...</span>
                    </div>
                    <div class="status-item">
                        <span>WebGL</span>
                        <span id="webgl-status" class="status-loading">Testando...</span>
                    </div>
                </div>
                
                <h3>‚ö° Performance</h3>
                <div class="performance-metrics">
                    <div class="metric">
                        <div class="metric-value" id="load-time">--</div>
                        <div class="metric-label">Tempo de Carga (ms)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="memory-usage">--</div>
                        <div class="metric-label">Mem√≥ria (MB)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="fps">--</div>
                        <div class="metric-label">FPS</div>
                    </div>
                </div>
                
                <h3>üéÆ Controles</h3>
                <button class="btn" id="test-scatterplot" disabled>Testar ScatterplotLayer</button>
                <button class="btn" id="test-heatmap" disabled>Testar HeatmapLayer</button>
                <button class="btn" id="test-hexagon" disabled>Testar HexagonLayer</button>
                <button class="btn" id="test-eox" disabled>Testar EOX Integration</button>
                <button class="btn" id="benchmark" disabled>Executar Benchmark</button>
            </div>
            
            <!-- Painel do Mapa -->
            <div class="test-panel">
                <h2>üó∫Ô∏è Visualiza√ß√£o Deck.GL</h2>
                <div id="map" class="map-container"></div>
            </div>
        </div>
        
        <!-- Output do Python -->
        <div class="test-panel">
            <h2>üêç Python Output</h2>
            <div id="python-output" class="code-output">Aguardando inicializa√ß√£o do Pyodide...</div>
        </div>
        
        <!-- Console de Debug -->
        <div class="test-panel">
            <h2>üîç Console de Debug</h2>
            <div id="debug-console" class="code-output"></div>
        </div>
    </div>
    
    <script>
        // Sistema de logging
        const debugLog = (message, type = 'info') => {
            const console = document.getElementById('debug-console');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#2196f3';
            console.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        };
        
        // Verificar WebGL
        const checkWebGL = () => {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
            if (gl) {
                document.getElementById('webgl-status').textContent = 'OK';
                document.getElementById('webgl-status').className = 'status-ok';
                debugLog('WebGL2/WebGL suportado', 'success');
                return true;
            } else {
                document.getElementById('webgl-status').textContent = 'ERRO';
                document.getElementById('webgl-status').className = 'status-error';
                debugLog('WebGL n√£o suportado', 'error');
                return false;
            }
        };
        
        // Verificar Deck.GL
        const checkDeckGL = () => {
            if (typeof deck !== 'undefined') {
                document.getElementById('deckgl-status').textContent = 'OK';
                document.getElementById('deckgl-status').className = 'status-ok';
                debugLog(`Deck.GL v${deck.VERSION || 'unknown'} carregado`, 'success');
                return true;
            } else {
                document.getElementById('deckgl-status').textContent = 'ERRO';
                document.getElementById('deckgl-status').className = 'status-error';
                debugLog('Deck.GL n√£o encontrado', 'error');
                return false;
            }
        };
        
        // Inicializar Pyodide
        let pyodide = null;
        let startTime = performance.now();
        
        async function initPyodide() {
            debugLog('Iniciando carregamento do Pyodide...');
            
            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
                });
                
                const loadTime = Math.round(performance.now() - startTime);
                document.getElementById('load-time').textContent = loadTime;
                
                document.getElementById('pyodide-status').textContent = 'OK';
                document.getElementById('pyodide-status').className = 'status-ok';
                debugLog(`Pyodide carregado em ${loadTime}ms`, 'success');
                
                // Instalar pacotes Python necess√°rios
                await pyodide.loadPackage(['numpy', 'micropip']);
                debugLog('Pacotes Python carregados', 'success');
                
                // Configurar bridge Python-JavaScript
                await setupPythonBridge();
                
                // Habilitar bot√µes
                document.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
                
                return true;
            } catch (error) {
                document.getElementById('pyodide-status').textContent = 'ERRO';
                document.getElementById('pyodide-status').className = 'status-error';
                debugLog(`Erro ao carregar Pyodide: ${error}`, 'error');
                return false;
            }
        }
        
        // Configurar bridge Python-JavaScript
        async function setupPythonBridge() {
            debugLog('Configurando bridge Python ‚Üî JavaScript...');
            
            const pythonCode = `
import json
import numpy as np
from js import deck, document, window

class DeckGLPyodideWrapper:
    """Wrapper para integrar Deck.GL com Python via Pyodide"""
    
    def __init__(self):
        self.deck_instance = None
        self.layers = []
        print("‚úÖ DeckGLPyodideWrapper inicializado")
    
    def create_scatterplot_layer(self, data, radius_scale=100):
        """Criar ScatterplotLayer para dados de Angola"""
        # Dados de exemplo: portos de Angola
        angola_ports = [
            {"name": "Luanda", "lat": -8.8368, "lng": 13.2343, "size": 100},
            {"name": "Lobito", "lat": -12.3644, "lng": 13.5366, "size": 80},
            {"name": "Namibe", "lat": -15.1961, "lng": 12.1522, "size": 60},
            {"name": "Cabinda", "lat": -5.5596, "lng": 12.1917, "size": 70},
            {"name": "Soyo", "lat": -6.1349, "lng": 12.3689, "size": 65}
        ]
        
        layer_config = {
            "type": "ScatterplotLayer",
            "id": "angola-ports",
            "data": angola_ports,
            "getPosition": "d => [d.lng, d.lat]",
            "getRadius": "d => d.size * " + str(radius_scale),
            "getFillColor": "[255, 140, 0]",
            "getLineColor": "[0, 0, 0]",
            "lineWidthMinPixels": 2,
            "radiusMinPixels": 5,
            "radiusMaxPixels": 100
        }
        
        self.layers.append(layer_config)
        print(f"üìç ScatterplotLayer criado com {len(angola_ports)} portos")
        return json.dumps(layer_config)
    
    def create_heatmap_layer(self, intensity=1):
        """Criar HeatmapLayer para atividade pesqueira"""
        # Dados simulados de atividade pesqueira
        fishing_activity = []
        np.random.seed(42)
        
        # Gerar pontos ao longo da costa angolana
        for i in range(200):
            lat = np.random.uniform(-17.266, -4.2)  # Latitude da ZEE Angola
            lng = np.random.uniform(11.5, 13.5)     # Longitude costeira
            weight = np.random.uniform(0.5, 1.0)
            
            fishing_activity.append({
                "lat": float(lat),
                "lng": float(lng),
                "weight": float(weight)
            })
        
        layer_config = {
            "type": "HeatmapLayer",
            "id": "fishing-activity",
            "data": fishing_activity,
            "getPosition": "d => [d.lng, d.lat]",
            "getWeight": "d => d.weight",
            "radiusPixels": 50,
            "intensity": intensity,
            "threshold": 0.03
        }
        
        self.layers.append(layer_config)
        print(f"üî• HeatmapLayer criado com {len(fishing_activity)} pontos")
        return json.dumps(layer_config)
    
    def create_hexagon_layer(self):
        """Criar HexagonLayer para densidade de esp√©cies"""
        # Dados simulados de observa√ß√µes de esp√©cies
        species_observations = []
        np.random.seed(123)
        
        # Clusters de biodiversidade
        clusters = [
            {"center": [-8.8, 13.2], "count": 50},   # Luanda
            {"center": [-12.3, 13.5], "count": 40},  # Lobito
            {"center": [-15.2, 12.1], "count": 35},  # Namibe
        ]
        
        for cluster in clusters:
            for _ in range(cluster["count"]):
                lat = cluster["center"][0] + np.random.normal(0, 0.5)
                lng = cluster["center"][1] + np.random.normal(0, 0.5)
                species_observations.append({
                    "lat": float(lat),
                    "lng": float(lng)
                })
        
        layer_config = {
            "type": "HexagonLayer",
            "id": "species-density",
            "data": species_observations,
            "getPosition": "d => [d.lng, d.lat]",
            "radius": 10000,
            "elevationScale": 4,
            "elevationRange": [0, 1000],
            "extruded": True,
            "coverage": 0.8
        }
        
        self.layers.append(layer_config)
        print(f"‚¨° HexagonLayer criado com {len(species_observations)} observa√ß√µes")
        return json.dumps(layer_config)
    
    def get_performance_metrics(self):
        """Obter m√©tricas de performance"""
        import sys
        
        # Estimar uso de mem√≥ria (aproximado)
        memory_mb = sys.getsizeof(self.layers) / 1024 / 1024
        
        metrics = {
            "layers_count": len(self.layers),
            "memory_mb": round(memory_mb, 2),
            "python_version": sys.version.split()[0]
        }
        
        return json.dumps(metrics)

# Criar inst√¢ncia global
deckgl_wrapper = DeckGLPyodideWrapper()
print("üöÄ Sistema Pyodide + Deck.GL pronto para uso!")
            `;
            
            try {
                await pyodide.runPython(pythonCode);
                
                document.getElementById('bridge-status').textContent = 'OK';
                document.getElementById('bridge-status').className = 'status-ok';
                
                const output = document.getElementById('python-output');
                output.textContent = pyodide.runPython('print("Sistema Python inicializado com sucesso!\\n"); "OK"');
                
                debugLog('Bridge Python ‚Üî JavaScript configurado', 'success');
                
                // Atualizar m√©tricas
                updateMetrics();
                
            } catch (error) {
                document.getElementById('bridge-status').textContent = 'ERRO';
                document.getElementById('bridge-status').className = 'status-error';
                debugLog(`Erro no bridge: ${error}`, 'error');
            }
        }
        
        // Atualizar m√©tricas
        function updateMetrics() {
            if (!pyodide) return;
            
            try {
                const metrics = JSON.parse(pyodide.runPython('deckgl_wrapper.get_performance_metrics()'));
                
                // Atualizar display de mem√≥ria
                if (metrics.memory_mb) {
                    document.getElementById('memory-usage').textContent = metrics.memory_mb;
                }
                
                // Simular FPS (para demonstra√ß√£o)
                let fps = 60;
                setInterval(() => {
                    fps = 55 + Math.random() * 10;
                    document.getElementById('fps').textContent = Math.round(fps);
                }, 1000);
                
            } catch (error) {
                debugLog(`Erro ao atualizar m√©tricas: ${error}`, 'error');
            }
        }
        
        // Inicializar mapa Deck.GL
        let deckInstance = null;
        
        function initDeckGL() {
            if (!checkDeckGL()) return;
            
            debugLog('Inicializando mapa Deck.GL...');
            
            // Configura√ß√£o inicial do Deck.GL
            deckInstance = new deck.DeckGL({
                container: 'map',
                mapStyle: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
                initialViewState: {
                    longitude: 13.2343,
                    latitude: -8.8368,
                    zoom: 5,
                    pitch: 0,
                    bearing: 0
                },
                controller: true
            });
            
            debugLog('Mapa Deck.GL inicializado', 'success');
        }
        
        // Testar ScatterplotLayer
        document.getElementById('test-scatterplot').addEventListener('click', async () => {
            if (!pyodide || !deckInstance) return;
            
            debugLog('Testando ScatterplotLayer...');
            const output = document.getElementById('python-output');
            
            try {
                // Chamar fun√ß√£o Python
                const layerJson = pyodide.runPython('deckgl_wrapper.create_scatterplot_layer(None, 200)');
                const layerConfig = JSON.parse(layerJson);
                
                // Criar layer no Deck.GL
                const layer = new deck.ScatterplotLayer({
                    id: layerConfig.id,
                    data: layerConfig.data,
                    getPosition: d => [d.lng, d.lat],
                    getRadius: d => d.size * 200,
                    getFillColor: [255, 140, 0],
                    getLineColor: [0, 0, 0],
                    lineWidthMinPixels: 2,
                    radiusMinPixels: 5,
                    radiusMaxPixels: 100
                });
                
                deckInstance.setProps({ layers: [layer] });
                
                output.innerHTML += '\n‚úÖ ScatterplotLayer renderizado com sucesso!';
                debugLog('ScatterplotLayer adicionado ao mapa', 'success');
                
            } catch (error) {
                output.innerHTML += `\n‚ùå Erro: ${error}`;
                debugLog(`Erro no ScatterplotLayer: ${error}`, 'error');
            }
        });
        
        // Testar HeatmapLayer
        document.getElementById('test-heatmap').addEventListener('click', async () => {
            if (!pyodide || !deckInstance) return;
            
            debugLog('Testando HeatmapLayer...');
            const output = document.getElementById('python-output');
            
            try {
                const layerJson = pyodide.runPython('deckgl_wrapper.create_heatmap_layer(2)');
                const layerConfig = JSON.parse(layerJson);
                
                const layer = new deck.HeatmapLayer({
                    id: layerConfig.id,
                    data: layerConfig.data,
                    getPosition: d => [d.lng, d.lat],
                    getWeight: d => d.weight,
                    radiusPixels: 50,
                    intensity: layerConfig.intensity,
                    threshold: 0.03
                });
                
                deckInstance.setProps({ layers: [layer] });
                
                output.innerHTML += '\n‚úÖ HeatmapLayer renderizado com sucesso!';
                debugLog('HeatmapLayer adicionado ao mapa', 'success');
                
            } catch (error) {
                output.innerHTML += `\n‚ùå Erro: ${error}`;
                debugLog(`Erro no HeatmapLayer: ${error}`, 'error');
            }
        });
        
        // Testar HexagonLayer
        document.getElementById('test-hexagon').addEventListener('click', async () => {
            if (!pyodide || !deckInstance) return;
            
            debugLog('Testando HexagonLayer...');
            const output = document.getElementById('python-output');
            
            try {
                const layerJson = pyodide.runPython('deckgl_wrapper.create_hexagon_layer()');
                const layerConfig = JSON.parse(layerJson);
                
                const layer = new deck.HexagonLayer({
                    id: layerConfig.id,
                    data: layerConfig.data,
                    getPosition: d => [d.lng, d.lat],
                    radius: layerConfig.radius,
                    elevationScale: layerConfig.elevationScale,
                    elevationRange: layerConfig.elevationRange,
                    extruded: layerConfig.extruded,
                    coverage: layerConfig.coverage
                });
                
                deckInstance.setProps({ 
                    layers: [layer],
                    initialViewState: {
                        longitude: 13.2343,
                        latitude: -8.8368,
                        zoom: 6,
                        pitch: 45,
                        bearing: -20
                    }
                });
                
                output.innerHTML += '\n‚úÖ HexagonLayer renderizado com sucesso!';
                debugLog('HexagonLayer adicionado ao mapa', 'success');
                
            } catch (error) {
                output.innerHTML += `\n‚ùå Erro: ${error}`;
                debugLog(`Erro no HexagonLayer: ${error}`, 'error');
            }
        });
        
        // Executar benchmark
        document.getElementById('benchmark').addEventListener('click', async () => {
            if (!pyodide || !deckInstance) return;
            
            debugLog('Executando benchmark...');
            const output = document.getElementById('python-output');
            
            output.innerHTML += '\n\nüèÅ Iniciando Benchmark...';
            
            const results = [];
            const iterations = 10;
            
            for (let i = 0; i < iterations; i++) {
                const start = performance.now();
                
                // Criar e renderizar layer
                const layerJson = pyodide.runPython(`deckgl_wrapper.create_scatterplot_layer(None, ${100 + i * 10})`);
                const layerConfig = JSON.parse(layerJson);
                
                const layer = new deck.ScatterplotLayer({
                    id: `benchmark-${i}`,
                    data: layerConfig.data,
                    getPosition: d => [d.lng, d.lat],
                    getRadius: d => d.size * (100 + i * 10),
                    getFillColor: [255, 140, 0]
                });
                
                deckInstance.setProps({ layers: [layer] });
                
                const end = performance.now();
                const time = end - start;
                results.push(time);
                
                output.innerHTML += `\n  Itera√ß√£o ${i + 1}: ${time.toFixed(2)}ms`;
            }
            
            const avg = results.reduce((a, b) => a + b, 0) / results.length;
            const min = Math.min(...results);
            const max = Math.max(...results);
            
            output.innerHTML += `\n\nüìä Resultados do Benchmark:`;
            output.innerHTML += `\n  ‚Ä¢ Tempo m√©dio: ${avg.toFixed(2)}ms`;
            output.innerHTML += `\n  ‚Ä¢ Tempo m√≠nimo: ${min.toFixed(2)}ms`;
            output.innerHTML += `\n  ‚Ä¢ Tempo m√°ximo: ${max.toFixed(2)}ms`;
            output.innerHTML += `\n  ‚Ä¢ Performance: ${avg < 50 ? 'üü¢ Excelente' : avg < 100 ? 'üü° Boa' : 'üî¥ Precisa otimiza√ß√£o'}`;
            
            debugLog(`Benchmark conclu√≠do - M√©dia: ${avg.toFixed(2)}ms`, 'success');
        });
        
        // Inicializar tudo
        window.addEventListener('load', async () => {
            checkWebGL();
            checkDeckGL();
            initDeckGL();
            await initPyodide();
        });
    </script>
</body>
</html>