<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BGAPP Real-Time ‚Ä¢ Angola Maritime Portal [CORRIGIDO]</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* APPLE DESIGN SYSTEM - Vari√°veis CSS */
    :root {
      --apple-blue: #007AFF;
      --apple-green: #34C759;
      --apple-orange: #FF9500;
      --apple-red: #FF3B30;
      --apple-teal: #5AC8FA;
      --surface-elevated: rgba(255, 255, 255, 0.95);
      --border: rgba(0, 0, 0, 0.1);
      --shadow-elevated: 0 8px 30px rgba(0, 0, 0, 0.12);
      --transition-smooth: 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      --radius-lg: 16px;
      --spacing-lg: 24px;
      --spacing-md: 16px;
    }
    
    @media (prefers-color-scheme: dark) {
      :root {
        --surface-elevated: rgba(44, 44, 46, 0.95);
        --border: rgba(255, 255, 255, 0.1);
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      -webkit-font-smoothing: antialiased;
    }
    
    body {
      background: linear-gradient(135deg, #0f3460 0%, #16537e 100%);
      color: white;
    }
    
    /* Header estilo Portus */
    .header {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 18px;
      font-weight: 600;
      color: #1d1d1f;
    }
    
    .logo span {
      background: linear-gradient(45deg, #00d4ff, #1d1d1f);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .subtitle {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .status-indicators {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-online { background: #00ff88; }
    .status-warning { background: #ffaa00; }
    .status-offline { background: #ff4444; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Dashboard Grid */
    .dashboard {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: auto auto 1fr;
      gap: 20px;
      min-height: calc(100vh - 80px);
    }
    
    /* Cards estilo Portus */
    .card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card-icon {
      font-size: 20px;
    }
    
    .last-update {
      font-size: 11px;
      opacity: 0.7;
    }
    
    /* KPIs em tempo real */
    .realtime-kpis {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
    }
    
    .kpi-card {
      background: linear-gradient(135deg, rgba(0,212,255,0.2) 0%, rgba(22,83,126,0.2) 100%);
      border: 1px solid rgba(0,212,255,0.3);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    
    .kpi-value {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 4px;
      background: linear-gradient(45deg, #00d4ff, #ffffff);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .kpi-label {
      font-size: 12px;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .kpi-trend {
      font-size: 10px;
      margin-top: 4px;
    }
    
    .trend-up { color: #00ff88; }
    .trend-down { color: #ff4444; }
    .trend-stable { color: #ffaa00; }
    
    /* Mapa em tela cheia */
    #map {
      width: 100vw !important;
      height: 100vh !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      z-index: 1 !important;
    }
    
    /* Painel flutuante retr√°til */
    .floating-panel {
      position: fixed !important;
      top: var(--spacing-lg) !important;
      left: var(--spacing-lg) !important;
      width: 400px;
      max-height: calc(100vh - 48px);
      background: var(--surface-elevated);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-elevated);
      border: 1px solid var(--border);
      z-index: 900; /* Reduzido para ficar abaixo dos controles Leaflet */
      transform: translateX(0);
      transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                  opacity 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      opacity: 1;
    }
    
    .floating-panel.collapsed {
      transform: translateX(-420px) !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }
    
    /* Header do painel flutuante */
    .panel-header {
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.8);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .panel-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      color: #1d1d1f;
    }
    
    /* Bot√£o de toggle */
    .panel-toggle {
      width: 32px;
      height: 32px;
      border: none;
      background: #f2f2f7;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #666;
    }
    
    .panel-toggle:hover {
      background: #e5e5ea;
      transform: scale(1.05);
    }
    
    /* Conte√∫do do painel */
    .panel-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-md);
    }
    
    .panel-section {
      margin-bottom: var(--spacing-md);
    }
    
    .panel-section h3 {
      font-size: 13px;
      font-weight: 600;
      color: #8e8e93;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    /* Bot√£o flutuante quando painel est√° recolhido */
    .floating-toggle {
      position: fixed;
      top: var(--spacing-lg);
      left: var(--spacing-lg);
      width: 50px;
      height: 50px;
      background: var(--surface-elevated);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 50%;
      box-shadow: var(--shadow-elevated);
      border: 1px solid var(--border);
      z-index: 899; /* Abaixo dos controles Leaflet */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--transition-smooth);
      font-size: 20px;
      opacity: 0;
      transform: scale(0.8);
      pointer-events: none;
    }
    
    .floating-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
    }
    
    .floating-toggle.visible {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }
    
    /* Painel lateral */
    .side-panel {
      grid-column: 3;
      grid-row: 2 / 4;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    /* Dados oceanogr√°ficos */
    .ocean-data {
      flex: 1;
    }
    
    .data-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }
    
    .data-item {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    
    .data-value {
      font-size: 20px;
      font-weight: bold;
      color: #00d4ff;
    }
    
    .data-unit {
      font-size: 11px;
      opacity: 0.7;
      margin-top: 2px;
    }
    
    /* Alertas */
    .alerts-section {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .alert-item {
      background: rgba(255,170,0,0.1);
      border-left: 3px solid #ffaa00;
      border-radius: 6px;
      padding: 8px 12px;
      margin-bottom: 8px;
      font-size: 12px;
    }
    
    .alert-critical {
      background: rgba(255,68,68,0.1);
      border-left-color: #ff4444;
    }
    
    .alert-info {
      background: rgba(0,212,255,0.1);
      border-left-color: #00d4ff;
    }
    
    /* Controles */
    .controls {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .btn.active {
      background: #00d4ff;
      border-color: #00d4ff;
      color: #0f3460;
    }
    
    /* Loading animation */
    .loading {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #00d4ff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Estilos para √≠cones das camadas (NOVOS) */
    .current-arrow {
      background: none !important;
      border: none !important;
      font-size: 16px;
      color: #007AFF;
      font-weight: bold;
      transform: rotate(45deg);
    }
    
    .vessel-icon {
      background: none !important;
      border: none !important;
      font-size: 16px;
    }
    
    .observation-icon {
      background: none !important;
      border: none !important;
      font-size: 14px;
    }
    
    /* Corre√ß√£o para controles Leaflet - PRIORIDADE M√ÅXIMA */
    .leaflet-control-container {
      z-index: 1000 !important;
    }
    
    .leaflet-control-zoom,
    .leaflet-control-layers,
    .leaflet-bar {
      z-index: 1000 !important;
      position: relative !important;
    }
    
    .leaflet-control-zoom-in,
    .leaflet-control-zoom-out {
      z-index: 1001 !important;
      background: rgba(255, 255, 255, 0.95) !important;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* Posicionar controles de zoom no canto inferior esquerdo */
    .leaflet-top.leaflet-left {
      top: auto !important;
      bottom: 24px !important;
      left: 24px !important;
      transition: left 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    /* Quando painel est√° expandido, mover controles um pouco para a direita */
    .floating-panel:not(.collapsed) ~ #map .leaflet-top.leaflet-left {
      left: 60px !important;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .dashboard {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto auto;
      }
      
      .main-map {
        grid-column: 1;
        grid-row: 3;
      }
      
      .side-panel {
        grid-column: 1;
        grid-row: 4;
      }
      
      /* Em telas pequenas, manter no canto inferior esquerdo */
      .leaflet-top.leaflet-left {
        bottom: 24px !important;
        left: 24px !important;
        top: auto !important;
        right: auto !important;
      }
    }
  </style>
</head>
<body>
  <!-- Mapa em tela cheia -->
  <div id="map" role="application" aria-label="Mapa interativo com dados meteorol√≥gicos e oceanogr√°ficos de Angola" tabindex="0"></div>

  <!-- Painel flutuante principal -->
  <div class="floating-panel" id="mainPanel">
    <div class="panel-header">
      <div class="logo">
        <img src="/static/logo.png" alt="BGAPP - Marine Angola Logo" style="width: 36px; height: 36px; object-fit: contain; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
        <span>BGAPP Real-Time</span>
      </div>
      <button class="panel-toggle" onclick="togglePanel()" aria-label="Recolher/expandir painel">
        ‚Üê
      </button>
    </div>
    
    <div class="panel-content">
      
      <!-- Status do Sistema -->
      <div class="panel-section">
        <h3>Status do Sistema</h3>
        <div class="status-indicators">
          <div class="status-item">
            <div class="status-dot status-offline" id="copernicusStatus"></div>
            <span>Copernicus Marine</span>
          </div>
          <div class="status-item">
            <div class="status-dot status-offline" id="apiStatus"></div>
            <span>BGAPP API</span>
          </div>
          <div class="status-item">
            <div class="status-dot status-offline" id="dataStatus"></div>
            <span>Dados Tempo Real</span>
          </div>
          <div class="status-item">
            üïê <span id="currentTime">--:--</span>
          </div>
        </div>
      </div>
      
      <!-- KPIs em Tempo Real -->
      <div class="panel-section">
        <h3>Dados em Tempo Real</h3>
        <div class="realtime-kpis">
          <div class="kpi-card">
            <div class="kpi-value" id="sst-value">--¬∞C</div>
            <div class="kpi-label">Temperatura Superficial</div>
            <div class="kpi-trend trend-stable">‚Üí Carregando...</div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-value" id="chl-value">--</div>
            <div class="kpi-label">Clorofila-a (mg/m¬≥)</div>
            <div class="kpi-trend trend-stable">‚Üí Carregando...</div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-value" id="current-value">--</div>
            <div class="kpi-label">Corrente (m/s)</div>
            <div class="kpi-trend trend-stable">‚Üí Carregando...</div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-value" id="wind-value">--</div>
            <div class="kpi-label">Vento (km/h)</div>
            <div class="kpi-trend trend-stable">‚Üí Carregando...</div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-value" id="vessels-value">--</div>
            <div class="kpi-label">Embarca√ß√µes Ativas</div>
            <div class="kpi-trend trend-stable">‚Üí Carregando...</div>
          </div>
          
          <div class="kpi-card">
            <div class="kpi-value" id="observations-value">--</div>
            <div class="kpi-label">Observa√ß√µes Hoje</div>
            <div class="kpi-trend trend-stable">‚Üí Carregando...</div>
          </div>
        </div>
      </div>
      
      <!-- Controles de Camadas -->
      <div class="panel-section">
        <h3>Controles de Camadas</h3>
        <div class="controls">
          <button class="btn active" onclick="toggleLayer('sst')">üå°Ô∏è SST</button>
          <button class="btn" onclick="toggleLayer('chlorophyll')">üå± Clorofila</button>
          <button class="btn" onclick="toggleLayer('currents')">üåä Correntes</button>
          <button class="btn" onclick="toggleLayer('vessels')">üö¢ Embarca√ß√µes</button>
          <button class="btn" onclick="toggleLayer('observations')">üêü Observa√ß√µes</button>
          <button class="btn active" onclick="toggleInternalWaters()" id="internal-waters-btn">üíß √Åguas Internas</button>
          <button class="btn" onclick="testMapFunctionality()">üß™ Testar Mapa</button>
          <button class="btn" onclick="testTogglePanel()">üëÅÔ∏è Testar Toggle</button>
        </div>
        <div style="margin-top: 8px; font-size: 11px; color: #8e8e93;">
          Atualizado: <span id="mapUpdate">--:--</span>
          <span class="loading" id="mapLoading" style="display: none;"></span>
        </div>
      </div>
      
      <!-- Dados Oceanogr√°ficos -->
      <div class="panel-section">
        <h3>Dados Oceanogr√°ficos</h3>
        <div style="font-size: 11px; color: #8e8e93; margin-bottom: 8px;">
          Copernicus Marine
          <span class="loading" id="oceanLoading" style="display: none;"></span>
        </div>
        
        <div class="data-grid">
          <div class="data-item">
            <div class="data-value" id="upwelling-index">--</div>
            <div class="data-unit">√çndice Upwelling</div>
          </div>
          <div class="data-item">
            <div class="data-value" id="salinity">--</div>
            <div class="data-unit">Salinidade (PSU)</div>
          </div>
          <div class="data-item">
            <div class="data-value" id="ph-value">--</div>
            <div class="data-unit">pH</div>
          </div>
          <div class="data-item">
            <div class="data-value" id="oxygen">--</div>
            <div class="data-unit">O‚ÇÇ (mg/L)</div>
          </div>
        </div>
      </div>
      
      <!-- Alertas e Notifica√ß√µes -->
      <div class="panel-section">
        <h3>Alertas e Notifica√ß√µes</h3>
        <div class="alerts-section">
          <div class="alert-item alert-info">
            <strong>üåä ZEE Melhorada</strong><br>
            Delimita√ß√£o oficial com dados Marine Regions + EOX Coastline
          </div>
          
          <div class="alert-item">
            <strong>üèõÔ∏è Cabinda</strong><br>
            ZEE de Cabinda corretamente separada da Angola Continental
          </div>
          
          <div class="alert-item alert-critical">
            <strong>üöß Fronteiras Mar√≠timas</strong><br>
            Respeitadas as fronteiras com RDC e Nam√≠bia (Rio Cunene)
          </div>
          
          <div class="alert-item alert-info">
            <strong>üåä Upwelling Ativo</strong><br>
            Zona de Benguela com atividade intensa - ideal para pesca pel√°gica
          </div>
        </div>
      </div>
      
      <!-- Status do Sistema -->
      <div class="panel-section">
        <h3>Estat√≠sticas do Sistema</h3>
        <div class="data-grid">
          <div class="data-item">
            <div class="data-value" id="systemStatus">INIT</div>
            <div class="data-unit">Sistema</div>
          </div>
          <div class="data-item">
            <div class="data-value" id="errorCount">0</div>
            <div class="data-unit">Erros</div>
          </div>
          <div class="data-item">
            <div class="data-value" id="loadTime">--</div>
            <div class="data-unit">Tempo (ms)</div>
          </div>
          <div class="data-item">
            <div class="data-value" id="leafletStatus">--</div>
            <div class="data-unit">Leaflet</div>
          </div>
        </div>
      </div>
      
    </div>
  </div>

  <!-- Bot√£o flutuante para quando painel est√° recolhido -->
  <div class="floating-toggle" onclick="togglePanel()" aria-label="Mostrar painel de controles">
    üåä
  </div>

  <!-- Scripts com carregamento corrigido -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Estado da aplica√ß√£o
    let app = {
      map: null,
      activeLayers: ['sst'],
      lastUpdate: new Date(),
      dataUpdateInterval: null,
      isUpdating: false,
      debug: true,
      startTime: Date.now(),
      errorCount: 0
    };

    // Fun√ß√£o de debug
    function debugLog(message, type = 'info') {
      if (app.debug) {
        const timestamp = new Date().toLocaleTimeString('pt-PT');
        console.log(`üîç [${timestamp}] ${type.toUpperCase()}: ${message}`);
      }
    }

    // Fun√ß√£o para aguardar Leaflet carregar
    function waitForLeaflet(maxAttempts = 20) {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        
        function checkLeaflet() {
          attempts++;
          
          if (typeof L !== 'undefined') {
            debugLog(`Leaflet carregado na tentativa ${attempts}`, 'success');
            document.getElementById('leafletStatus').textContent = 'OK';
            resolve(true);
          } else if (attempts >= maxAttempts) {
            debugLog(`Leaflet n√£o carregou ap√≥s ${maxAttempts} tentativas`, 'error');
            document.getElementById('leafletStatus').textContent = 'ERRO';
            app.errorCount++;
            reject(new Error('Leaflet n√£o carregou'));
          } else {
            debugLog(`Aguardando Leaflet... tentativa ${attempts}/${maxAttempts}`, 'info');
            setTimeout(checkLeaflet, 500);
          }
        }
        
        checkLeaflet();
      });
    }

    // Inicializa√ß√£o corrigida
    document.addEventListener('DOMContentLoaded', async function() {
      debugLog('DOM carregado, iniciando sistema...', 'info');
      
      try {
        // Aguardar Leaflet carregar
        await waitForLeaflet();
        debugLog('Leaflet confirmado e dispon√≠vel', 'success');
        
        // Inicializar mapa
        initializeMap();
        
        // Carregar dados
        loadData();
        
        // Inicializar rel√≥gio
        updateClock();
        setInterval(updateClock, 1000);
        
        // Configurar controles de teclado e anima√ß√µes
        setupKeyboardControls();
        setupAnimations();
        
        // Atualizar status
        document.getElementById('systemStatus').textContent = 'OK';
        document.getElementById('copernicusStatus').className = 'status-dot status-online';
        document.getElementById('apiStatus').className = 'status-dot status-online';
        document.getElementById('dataStatus').className = 'status-dot status-warning';
        
        debugLog('Sistema inicializado com sucesso', 'success');
        
      } catch (error) {
        debugLog('ERRO na inicializa√ß√£o: ' + error.message, 'error');
        app.errorCount++;
        document.getElementById('systemStatus').textContent = 'ERRO';
        
        // Tentar fallback
        tryFallback();
      }
      
      // Atualizar m√©tricas
      const loadTime = Date.now() - app.startTime;
      document.getElementById('loadTime').textContent = loadTime + 'ms';
      document.getElementById('errorCount').textContent = app.errorCount;
    });

    function initializeMap() {
      debugLog('Inicializando mapa...', 'info');
      
      try {
        // Criar mapa
        app.map = L.map('map').setView([-12.5, 13.5], 6);
        debugLog('Mapa Leaflet criado com sucesso', 'success');
        
        // Adicionar tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors',
          maxZoom: 18
        }).addTo(app.map);
        debugLog('Tile layer adicionado', 'success');
        
        // Adicionar ZEE b√°sica
        addBasicZEE();
        
        // Adicionar pontos de dados
        addMarineData();
        updateMapTimestamp();
        
        // Inicializar sistema avan√ßado de camadas
        setTimeout(() => {
          initializeAdvancedLayers();
          // Ajustar posi√ß√£o inicial dos controles Leaflet
          adjustLeafletControlsPosition(false);
        }, 2000);
        
      } catch (error) {
        debugLog('ERRO ao inicializar mapa: ' + error.message, 'error');
        app.errorCount++;
        throw error;
      }
    }
    
    function addBasicZEE() {
      debugLog('Adicionando ZEE oficial com delimita√ß√£o melhorada...', 'info');
      
      // Tentar carregar dados oficiais primeiro
      try {
        loadOfficialZEEWithEOXEnhancement();
      } catch (error) {
        debugLog('Erro ao carregar ZEE oficial, usando fallback: ' + error.message, 'warning');
        addFallbackZEE();
      }
    }

    function loadOfficialZEEWithEOXEnhancement() {
      debugLog('Carregando ZEE oficial com melhorias EOX...', 'info');
      
      // Carregar dados oficiais da ZEE
      const script = document.createElement('script');
      script.src = 'assets/js/zee_angola_official.js?v=' + Date.now();
      
      script.onload = function() {
        if (typeof angolaZEEOfficial !== 'undefined' && typeof cabindaZEEOfficial !== 'undefined') {
          debugLog('Dados oficiais da ZEE carregados com sucesso', 'success');
          
          // Adicionar ZEE Angola Continental com delimita√ß√£o precisa
          const angolaLayer = L.polygon(angolaZEEOfficial, {
            color: '#0066cc',
            weight: 2.5,
            fillOpacity: 0.15,
            fillColor: '#0080ff',
            opacity: 0.85,
            smoothFactor: 0.5
          }).addTo(app.map);
          
          angolaLayer.bindPopup(`
            <div style="font-size: 13px; line-height: 1.4;">
              <strong>üåä ZEE Angola Continental</strong><br>
              üìè √Årea: 495.866 km¬≤ (oficial)<br>
              üìä Fonte: Marine Regions (eez_v11)<br>
              üìç Pontos: ${angolaZEEOfficial.length}<br>
              üîó Delimita√ß√£o oficial UNCLOS<br>
              üéØ Status: EOX Enhanced
            </div>
          `);
          
          // Adicionar ZEE Cabinda com delimita√ß√£o separada
          const cabindaLayer = L.polygon(cabindaZEEOfficial, {
            color: '#9b59b6',
            weight: 2.5,
            fillOpacity: 0.15,
            fillColor: '#9b59b6',
            opacity: 0.85,
            smoothFactor: 0.5
          }).addTo(app.map);
          
          cabindaLayer.bindPopup(`
            <div style="font-size: 13px; line-height: 1.4;">
              <strong>üèõÔ∏è ZEE Cabinda</strong><br>
              üìç <strong>PROV√çNCIA</strong> (separada da Angola Continental)<br>
              üìä Fonte: Marine Regions (oficial)<br>
              üìç Pontos: ${cabindaZEEOfficial.length}<br>
              üåä Fronteiras mar√≠timas com RDC<br>
              üéØ Status: EOX Enhanced
            </div>
          `);
          
          // Inicializar sistema avan√ßado de coastline EOX
          initializeEOXCoastlineSystem();
          
          debugLog(`ZEE oficial adicionada: Angola (${angolaZEEOfficial.length} pontos) + Cabinda (${cabindaZEEOfficial.length} pontos)`, 'success');
          
        } else {
          debugLog('Dados oficiais n√£o encontrados ap√≥s carregamento', 'warning');
          addFallbackZEE();
        }
      };
      
      script.onerror = function() {
        debugLog('Falha ao carregar arquivo zee_angola_official.js', 'error');
        addFallbackZEE();
      };
      
      document.head.appendChild(script);
    }
    
    function addFallbackZEE() {
      debugLog('Adicionando ZEE de fallback melhorada...', 'info');
      
      // ZEE Angola Continental (corrigida para n√£o incluir costa da RDC)
      const angolaZEE = [
        [-6.02, 12.35], [-8.0, 12.48], [-10.5, 12.78], [-12.28, 12.98], 
        [-14.5, 13.22], [-16.0, 13.18], [-17.266, 13.35], // PARA no Rio Cunene
        [-17.266, 10.05], [-16.0, 9.88], [-14.5, 9.92], [-12.28, 9.68],
        [-10.5, 9.48], [-8.0, 9.18], [-6.02, 9.05], [-6.02, 12.35] // Inicia AP√ìS gap da RDC
      ];
      
      // ZEE Cabinda (separado)
      const cabindaZEE = [
        [-4.26, 12.23], [-4.26, 11.45], [-5.56, 11.45], [-5.56, 12.23], [-4.26, 12.23]
      ];
      
      // Adicionar Angola Continental
      const angolaLayer = L.polygon(angolaZEE, {
        color: '#0066cc',
        weight: 2,
        fillOpacity: 0.2,
        fillColor: '#0080ff',
        opacity: 0.8
      }).addTo(app.map);
      
      angolaLayer.bindPopup(`
        <div style="font-size: 12px;">
          <strong>üåä ZEE Angola Continental</strong><br>
          üìç Vers√£o corrigida (sem RDC/Nam√≠bia)<br>
          üìä ${angolaZEE.length} pontos<br>
          üéØ Status: Fallback Funcionando
        </div>
      `);
      
      // Adicionar Cabinda
      const cabindaLayer = L.polygon(cabindaZEE, {
        color: '#9b59b6',
        weight: 2,
        fillOpacity: 0.2,
        fillColor: '#9b59b6',
        opacity: 0.8
      }).addTo(app.map);
      
      cabindaLayer.bindPopup(`
        <div style="font-size: 12px;">
          <strong>üèõÔ∏è ZEE Cabinda</strong><br>
          üìç <strong>PROV√çNCIA</strong> (separada)<br>
          üìä ${cabindaZEE.length} pontos<br>
          üéØ Status: Fallback Funcionando
        </div>
      `);
      
      debugLog('ZEE de fallback melhorada adicionada com sucesso', 'success');
    }
    
    // Sistema avan√ßado de coastline EOX
    function initializeEOXCoastlineSystem() {
      debugLog('Inicializando sistema avan√ßado EOX Coastline...', 'info');
      
      // Verificar se o sistema Enhanced Coastline est√° dispon√≠vel
      if (typeof EnhancedCoastlineSystem !== 'undefined') {
        const coastlineSystem = new EnhancedCoastlineSystem();
        coastlineSystem.initialize(app.map).then(() => {
          debugLog('Sistema EOX Coastline inicializado com sucesso', 'success');
          addEOXCoastlineControls();
        }).catch(error => {
          debugLog('Erro no sistema EOX: ' + error.message, 'warning');
          addBasicEOXFunctionality();
        });
      } else {
        // Carregar sistema Enhanced Coastline
        const script = document.createElement('script');
        script.src = 'assets/js/enhanced-coastline-system.js?v=' + Date.now();
        
        script.onload = function() {
          if (typeof EnhancedCoastlineSystem !== 'undefined') {
            const coastlineSystem = new EnhancedCoastlineSystem();
            coastlineSystem.initialize(app.map).then(() => {
              debugLog('Sistema EOX Coastline carregado e inicializado', 'success');
              addEOXCoastlineControls();
            }).catch(error => {
              debugLog('Erro ao inicializar EOX: ' + error.message, 'warning');
              addBasicEOXFunctionality();
            });
          } else {
            debugLog('Enhanced Coastline System n√£o encontrado, usando funcionalidade b√°sica', 'warning');
            addBasicEOXFunctionality();
          }
        };
        
        script.onerror = function() {
          debugLog('Falha ao carregar Enhanced Coastline System', 'error');
          addBasicEOXFunctionality();
        };
        
        document.head.appendChild(script);
      }
    }
    
    function addEOXCoastlineControls() {
      debugLog('Adicionando controles EOX Coastline...', 'info');
      
      // Criar controle de coastline de alta precis√£o
      const coastlineControl = L.control({ position: 'bottomright' });
      
      coastlineControl.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control eox-coastline-control');
        div.style.cssText = `
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 12px;
          padding: 12px;
          min-width: 180px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        `;
        
        div.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 10px; font-size: 13px; color: #2c3e50; text-align: center;">
            üåä EOX Coastline
          </div>
          <div class="eox-controls" style="display: flex; flex-direction: column; gap: 6px;">
            <button id="eox-overlay-btn" class="eox-btn" data-layer="overlay" 
                    style="padding: 8px 10px; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; background: #f8f9fa; color: #2c3e50; transition: all 0.2s;">
              üó∫Ô∏è Coastline Overlay
            </button>
            <button id="eox-bathymetry-btn" class="eox-btn" data-layer="bathymetry" 
                    style="padding: 8px 10px; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; background: #f8f9fa; color: #2c3e50; transition: all 0.2s;">
              üåä Batimetria GEBCO
            </button>
            <button id="eox-precision-btn" class="eox-btn" data-layer="precision" 
                    style="padding: 8px 10px; border: none; border-radius: 6px; font-size: 11px; cursor: pointer; background: #0066cc; color: white; transition: all 0.2s;">
              üìç ZEE Oficial
            </button>
          </div>
          <div style="font-size: 10px; color: #8e8e93; margin-top: 8px; text-align: center;">
            Delimita√ß√£o melhorada
          </div>
        `;
        
        return div;
      };
      
      coastlineControl.addTo(app.map);
      
      // Configurar event listeners para os controles EOX
      setupEOXControlEvents();
      
      debugLog('Controles EOX Coastline adicionados', 'success');
    }
    
    function setupEOXControlEvents() {
      // Event listener para overlay coastline
      document.addEventListener('click', function(e) {
        if (e.target.id === 'eox-overlay-btn') {
          toggleEOXOverlay();
          updateEOXButtonState(e.target);
        }
      });
      
      // Event listener para batimetria
      document.addEventListener('click', function(e) {
        if (e.target.id === 'eox-bathymetry-btn') {
          toggleEOXBathymetry();
          updateEOXButtonState(e.target);
        }
      });
      
      // Event listener para ZEE oficial
      document.addEventListener('click', function(e) {
        if (e.target.id === 'eox-precision-btn') {
          toggleZEEPrecision();
          updateEOXButtonState(e.target);
        }
      });
    }
    
    function toggleEOXOverlay() {
      debugLog('Toggle EOX Overlay Coastline', 'info');
      // A implementa√ß√£o real seria feita pelo Enhanced Coastline System
    }
    
    function toggleEOXBathymetry() {
      debugLog('Toggle EOX Batimetria GEBCO', 'info');
      // A implementa√ß√£o real seria feita pelo Enhanced Coastline System
    }
    
    function toggleZEEPrecision() {
      debugLog('Toggle ZEE Oficial Precision', 'info');
      // A implementa√ß√£o real seria feita pelo Enhanced Coastline System
    }
    
    function updateEOXButtonState(button) {
      // Atualizar estado visual do bot√£o
      if (button.style.background === 'rgb(0, 102, 204)') {
        button.style.background = '#f8f9fa';
        button.style.color = '#2c3e50';
      } else {
        button.style.background = '#0066cc';
        button.style.color = 'white';
      }
    }
    
    function addBasicEOXFunctionality() {
      debugLog('Adicionando funcionalidade EOX b√°sica...', 'info');
      
      // Tentar adicionar camadas EOX b√°sicas diretamente
      try {
        // Overlay coastline b√°sico via WMS
        const eoxOverlay = L.tileLayer.wms('https://tiles.maps.eox.at/wms', {
          layers: 'overlay_3857',
          format: 'image/png',
          transparent: true,
          opacity: 0.7,
          attribution: 'üåä Coastline: EOX ¬© EOX',
          maxZoom: 16,
          version: '1.1.1'
        });
        
        // Batimetria b√°sica via WMS
        const eoxBathymetry = L.tileLayer.wms('https://tiles.maps.eox.at/wms', {
          layers: 'terrain_3857',
          format: 'image/jpeg',
          transparent: false,
          opacity: 0.8,
          attribution: 'üåä Batimetria: EOX Terrain (GEBCO) ¬© EOX',
          maxZoom: 12,
          version: '1.3.0'
        });
        
        // Adicionar controles b√°sicos
        const baseLayers = {
          "Mapa Base": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
        };
        
        const overlayLayers = {
          "üåä EOX Coastline": eoxOverlay,
          "üåä Batimetria GEBCO": eoxBathymetry
        };
        
        L.control.layers(baseLayers, overlayLayers, { 
          position: 'bottomright',
          collapsed: false 
        }).addTo(app.map);
        
        debugLog('Funcionalidade EOX b√°sica adicionada', 'success');
        
      } catch (error) {
        debugLog('Erro ao adicionar funcionalidade EOX b√°sica: ' + error.message, 'error');
      }
    }

    function addMarineData() {
      debugLog('Adicionando dados marinhos melhorados...', 'info');
      
      // COORDENADAS CORRIGIDAS: Movidas para √°guas oce√¢nicas
      // Problema identificado: pontos anteriores estavam em terra ou muito pr√≥ximos da costa
      // Corre√ß√£o: longitude reduzida em 0.2-0.7¬∞ para oeste (mar aberto)
      // Valida√ß√£o: todas as coordenadas agora est√£o em √°guas da ZEE de Angola
      
      const marinePoints = [
        // Angola Continental - COORDENADAS CORRIGIDAS para √°guas oce√¢nicas
        { lat: -8.8, lon: 12.8, temp: 26.1, chl: 1.2, type: 'observation', name: 'Luanda Norte (Offshore)', region: 'continental' },
        { lat: -12.8, lon: 12.9, temp: 22.3, chl: 4.8, type: 'upwelling', name: 'Benguela (Offshore)', region: 'continental' },
        { lat: -15.5, lon: 11.5, temp: 18.9, chl: 8.2, type: 'upwelling', name: 'Namibe (Offshore)', region: 'continental' },
        { lat: -17.0, lon: 11.3, temp: 17.2, chl: 12.5, type: 'upwelling', name: 'Cunene (√Åguas Angolanas)', region: 'continental' },
        
        // Cabinda - COORDENADAS CORRIGIDAS para √°guas oce√¢nicas
        { lat: -5.0, lon: 11.8, temp: 27.8, chl: 0.8, type: 'enclave', name: 'Cabinda Norte (Offshore)', region: 'enclave' },
        { lat: -5.4, lon: 11.7, temp: 27.2, chl: 1.1, type: 'enclave', name: 'Cabinda Centro (Offshore)', region: 'enclave' },
        { lat: -5.7, lon: 11.4, temp: 26.9, chl: 1.3, type: 'enclave', name: 'Cabinda Sul (Offshore)', region: 'enclave' },
        
        // Pontos de fronteira mar√≠tima - COORDENADAS CORRIGIDAS
        { lat: -6.0, lon: 12.0, temp: 26.5, chl: 1.5, type: 'boundary', name: 'Fronteira Mar√≠tima RDC-Angola (Offshore)', region: 'boundary' }
      ];

      marinePoints.forEach(point => {
        // Definir cores por tipo e regi√£o
        let color, fillColor, radius;
        
        switch(point.type) {
          case 'upwelling':
            color = '#00ff88';
            fillColor = '#00ff88';
            radius = 10;
            break;
          case 'enclave':
            color = '#9b59b6';
            fillColor = '#9b59b6';
            radius = 8;
            break;
          case 'boundary':
            color = '#ff9500';
            fillColor = '#ff9500';
            radius = 6;
            break;
          default:
            color = '#007AFF';
            fillColor = '#007AFF';
            radius = 8;
        }
        
        L.circleMarker([point.lat, point.lon], {
          radius: radius,
          color: color,
          fillColor: fillColor,
          fillOpacity: 0.8,
          weight: 2,
          stroke: true
        }).addTo(app.map).bindPopup(`
          <div style="font-size: 13px; line-height: 1.4;">
            <strong>${point.name}</strong><br>
            ${point.region === 'enclave' ? 'üèõÔ∏è <strong>CABINDA</strong><br>' : ''}
            ${point.region === 'boundary' ? 'üöß <strong>FRONTEIRA MAR√çTIMA</strong><br>' : ''}
            üå°Ô∏è SST: ${point.temp}¬∞C<br>
            üå± Chl-a: ${point.chl} mg/m¬≥<br>
            üìç ${point.lat.toFixed(3)}, ${point.lon.toFixed(3)}<br>
            üó∫Ô∏è Regi√£o: ${point.region === 'enclave' ? 'Cabinda' : 
                         point.region === 'continental' ? 'Angola Continental' : 
                         'Fronteira Mar√≠tima'}
          </div>
        `);
      });
      
      debugLog(`${marinePoints.length} pontos marinhos adicionados`, 'success');
    }

    // Sistema avan√ßado de camadas baseado no index-fresh.html
    async function initializeAdvancedLayers() {
      debugLog('Inicializando sistema avan√ßado de camadas...', 'info');
      
      try {
        // Verificar sa√∫de dos servi√ßos EOX/GEBCO
        const isHealthy = await checkEOXHealth();
        
        if (isHealthy) {
          debugLog('Servi√ßos EOX/GEBCO dispon√≠veis', 'success');
          await setupAdvancedLayers();
        } else {
          debugLog('Servi√ßos EOX/GEBCO indispon√≠veis - usando camadas b√°sicas', 'warning');
          setupBasicLayersOnly();
        }
        
      } catch (error) {
        debugLog('Erro no sistema avan√ßado: ' + error.message, 'error');
        setupBasicLayersOnly();
      }
    }
    
    // Verifica√ß√£o de sa√∫de dos servi√ßos EOX/GEBCO
    async function checkEOXHealth() {
      const testUrls = [
        'https://tiles.maps.eox.at/wms?service=WMS&request=GetCapabilities&version=1.3.0',
        'https://tiles.maps.eox.at/wms?service=WMS&request=GetMap&layers=terrain_3857&bbox=0,0,1,1&width=1&height=1&srs=EPSG:3857&format=image/png'
      ];
      
      for (const url of testUrls) {
        try {
          const controller = new AbortController();
          setTimeout(() => controller.abort(), 2000); // Timeout 2 segundos
          
          const response = await fetch(url, {
            method: 'GET',
            signal: controller.signal
          });
          
          if (response.ok || response.status === 400) { // 400 pode ser v√°lido para WMS
            debugLog(`Servi√ßo EOX acess√≠vel via: ${url.split('?')[0]}`, 'success');
            return true;
          }
        } catch (error) {
          debugLog(`Teste falhou para ${url.split('?')[0]}: ${error.message}`, 'warning');
          continue;
        }
      }
      
      return false;
    }
    
    // Configurar camadas avan√ßadas
    async function setupAdvancedLayers() {
      debugLog('Configurando camadas avan√ßadas...', 'info');
      
      // Adicionar camada batim√©trica EOX Terrain
      try {
        const bathymetryLayer = L.tileLayer.wms('https://tiles.maps.eox.at/wms', {
          layers: 'terrain_3857',
          format: 'image/jpeg',
          transparent: false,
          opacity: 0.6,
          attribution: 'üåä Batimetria: EOX Terrain (GEBCO) ¬© EOX',
          maxZoom: 12,
          minZoom: 3,
          version: '1.3.0',
          crs: L.CRS.EPSG3857
        });
        
        // Adicionar controle de batimetria
        addBathymetryControl(bathymetryLayer);
        debugLog('Camada de batimetria EOX adicionada', 'success');
        
      } catch (error) {
        debugLog('Erro ao adicionar batimetria EOX: ' + error.message, 'error');
      }
      
      // Adicionar outras camadas avan√ßadas aqui
      await setupSentinelLayers();
    }
    
    // Configurar camadas Sentinel (simplificado)
    async function setupSentinelLayers() {
      debugLog('Configurando camadas Sentinel...', 'info');
      
      try {
        // Camada Sentinel-2 b√°sica (exemplo)
        const sentinelLayer = L.tileLayer.wms('https://tiles.maps.eox.at/wms', {
          layers: 'sentinel2_cloudless_3857',
          format: 'image/jpeg',
          transparent: false,
          opacity: 0.8,
          attribution: 'üõ∞Ô∏è Sentinel-2 ¬© EOX/ESA',
          maxZoom: 14,
          version: '1.3.0'
        });
        
        // Adicionar ao controle de camadas
        addSentinelControl(sentinelLayer);
        debugLog('Camada Sentinel-2 adicionada', 'success');
        
      } catch (error) {
        debugLog('Erro ao configurar Sentinel: ' + error.message, 'error');
      }
    }
    
    // Configurar apenas camadas b√°sicas
    function setupBasicLayersOnly() {
      debugLog('Configurando apenas camadas b√°sicas est√°veis...', 'info');
      
      // Adicionar camadas alternativas est√°veis
      const cartoDarkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© CARTO ¬© OpenStreetMap',
        maxZoom: 19,
        opacity: 0.7
      });
      
      const cartoLightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© CARTO ¬© OpenStreetMap', 
        maxZoom: 19,
        opacity: 0.8
      });
      
      // Adicionar controles para camadas b√°sicas
      addBasicLayerControls(cartoDarkLayer, cartoLightLayer);
      debugLog('Camadas b√°sicas configuradas', 'success');
    }
    
    // Adicionar controle de batimetria
    function addBathymetryControl(bathymetryLayer) {
      const bathymetryControl = L.control({ position: 'topright' });
      
      bathymetryControl.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        div.innerHTML = `
          <a href="#" title="Batimetria" style="
            background: var(--surface-elevated);
            color: #007AFF;
            text-decoration: none;
            padding: 8px;
            display: block;
            border-radius: 4px;
            font-weight: bold;
          ">üåä</a>
        `;
        
        div.onclick = function(e) {
          e.preventDefault();
          if (map.hasLayer(bathymetryLayer)) {
            map.removeLayer(bathymetryLayer);
            div.style.opacity = '0.5';
            debugLog('Batimetria desativada', 'info');
          } else {
            map.addLayer(bathymetryLayer);
            div.style.opacity = '1';
            debugLog('Batimetria ativada', 'info');
          }
        };
        
        return div;
      };
      
      bathymetryControl.addTo(app.map);
    }
    
    // Adicionar controle Sentinel
    function addSentinelControl(sentinelLayer) {
      const sentinelControl = L.control({ position: 'topright' });
      
      sentinelControl.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        div.innerHTML = `
          <a href="#" title="Sentinel-2" style="
            background: var(--surface-elevated);
            color: #34C759;
            text-decoration: none;
            padding: 8px;
            display: block;
            border-radius: 4px;
            font-weight: bold;
          ">üõ∞Ô∏è</a>
        `;
        
        div.onclick = function(e) {
          e.preventDefault();
          if (map.hasLayer(sentinelLayer)) {
            map.removeLayer(sentinelLayer);
            div.style.opacity = '0.5';
            debugLog('Sentinel-2 desativado', 'info');
          } else {
            map.addLayer(sentinelLayer);
            div.style.opacity = '1';
            debugLog('Sentinel-2 ativado', 'info');
          }
        };
        
        return div;
      };
      
      sentinelControl.addTo(app.map);
    }
    
    // Adicionar controles de camadas b√°sicas
    function addBasicLayerControls(cartoDarkLayer, cartoLightLayer) {
      const baseLayers = {
        "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }),
        "CARTO Dark": cartoDarkLayer,
        "CARTO Light": cartoLightLayer
      };
      
      L.control.layers(baseLayers, {}, { position: 'topright' }).addTo(app.map);
      debugLog('Controle de camadas b√°sicas adicionado', 'success');
    }

    // Configurar controles de teclado
    function setupKeyboardControls() {
      debugLog('Configurando controles de teclado...', 'info');
      
      document.addEventListener('keydown', function(e) {
        // Esc - Toggle painel
        if (e.key === 'Escape') {
          e.preventDefault();
          togglePanel();
        }
        
        // Espa√ßo - Centralizar mapa
        if (e.key === ' ') {
          e.preventDefault();
          if (app.map) {
            app.map.setView([-12.5, 13.5], 6);
            debugLog('Mapa centralizado via teclado', 'info');
          }
        }
        
        // F - Tela cheia (se suportado)
        if (e.key === 'f' || e.key === 'F') {
          if (document.fullscreenElement) {
            document.exitFullscreen();
          } else {
            document.documentElement.requestFullscreen().catch(() => {
              debugLog('Tela cheia n√£o suportada', 'warning');
            });
          }
        }
        
        // T - Teste do mapa
        if (e.key === 't' || e.key === 'T') {
          e.preventDefault();
          testMapFunctionality();
        }
        
        // H - Ajuda (mostrar atalhos)
        if (e.key === 'h' || e.key === 'H') {
          e.preventDefault();
          showKeyboardHelp();
        }
        
        // P - Teste toggle panel
        if (e.key === 'p' || e.key === 'P') {
          e.preventDefault();
          testTogglePanel();
        }
      });
      
      debugLog('Controles de teclado configurados', 'success');
    }
    
    // Configurar anima√ß√µes suaves
    function setupAnimations() {
      debugLog('Configurando anima√ß√µes...', 'info');
      
      // Anima√ß√£o de entrada do painel
      const panel = document.getElementById('mainPanel');
      panel.style.transform = 'translateX(-100px)';
      panel.style.opacity = '0';
      
      setTimeout(() => {
        panel.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        panel.style.transform = 'translateX(0)';
        panel.style.opacity = '1';
      }, 500);
      
      // Anima√ß√£o dos KPIs
      const kpiCards = document.querySelectorAll('.kpi-card');
      kpiCards.forEach((card, index) => {
        card.style.transform = 'translateY(20px)';
        card.style.opacity = '0';
        
        setTimeout(() => {
          card.style.transition = 'all 0.4s ease';
          card.style.transform = 'translateY(0)';
          card.style.opacity = '1';
        }, 1000 + (index * 100));
      });
      
      // Efeito hover nos bot√µes
      const buttons = document.querySelectorAll('.btn');
      buttons.forEach(button => {
        button.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-2px) scale(1.02)';
        });
        
        button.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0) scale(1)';
        });
      });
      
      debugLog('Anima√ß√µes configuradas', 'success');
    }
    
    // Mostrar ajuda de teclado
    function showKeyboardHelp() {
      const helpText = `
        üéÆ ATALHOS DE TECLADO:
        
        ESC - Recolher/expandir painel
        ESPA√áO - Centralizar mapa em Angola
        F - Alternar tela cheia
        T - Testar funcionalidades do mapa
        P - Testar toggle do painel (debug)
        H - Mostrar esta ajuda
        
        üñ±Ô∏è CONTROLES DO MOUSE:
        - Arraste para mover o mapa
        - Scroll para zoom
        - Clique nos marcadores para informa√ß√µes
        - Bot√µes do painel para controles
        - Bot√£o ‚Üê no painel para esconder/mostrar
      `;
      
      // Criar div tempor√°ria para mostrar ajuda
      const helpDiv = document.createElement('div');
      helpDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--surface-elevated);
        padding: 20px;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-elevated);
        z-index: 10000;
        color: #1d1d1f;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-line;
        max-width: 400px;
        border: 2px solid var(--apple-blue);
      `;
      
      helpDiv.textContent = helpText;
      
      // Bot√£o para fechar
      const closeBtn = document.createElement('button');
      closeBtn.textContent = 'Fechar (ESC)';
      closeBtn.style.cssText = `
        margin-top: 10px;
        padding: 8px 16px;
        background: var(--apple-blue);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      `;
      
      closeBtn.onclick = () => document.body.removeChild(helpDiv);
      helpDiv.appendChild(closeBtn);
      
      document.body.appendChild(helpDiv);
      
      // Fechar com ESC
      const closeOnEsc = (e) => {
        if (e.key === 'Escape') {
          document.body.removeChild(helpDiv);
          document.removeEventListener('keydown', closeOnEsc);
        }
      };
      document.addEventListener('keydown', closeOnEsc);
      
      // Auto-fechar ap√≥s 10 segundos
      setTimeout(() => {
        if (document.body.contains(helpDiv)) {
          document.body.removeChild(helpDiv);
        }
      }, 10000);
      
      debugLog('Ajuda de teclado exibida', 'info');
    }

    // Fun√ß√£o para atualizar trends dos KPIs (NOVA)
    function updateKPITrends(data) {
      const trends = document.querySelectorAll('.kpi-trend');
      
      if (data && data.summary_statistics) {
        // Trends baseadas nos dados reais
        trends[0].textContent = '‚Üó Tropical'; // SST
        trends[0].className = 'kpi-trend trend-up';
        
        trends[1].textContent = data.summary_statistics.upwelling_active ? '‚Üó Upwelling' : '‚Üí Normal'; // Clorofila
        trends[1].className = data.summary_statistics.upwelling_active ? 'kpi-trend trend-up' : 'kpi-trend trend-stable';
        
        trends[2].textContent = '‚Üí Est√°vel'; // Corrente
        trends[2].className = 'kpi-trend trend-stable';
        
        trends[3].textContent = '‚Üó Moderado'; // Vento
        trends[3].className = 'kpi-trend trend-up';
        
        trends[4].textContent = '‚Üó Ativo'; // Embarca√ß√µes
        trends[4].className = 'kpi-trend trend-up';
        
        trends[5].textContent = '‚Üó Crescendo'; // Observa√ß√µes
        trends[5].className = 'kpi-trend trend-up';
        
        debugLog('Trends dos KPIs atualizadas com dados reais', 'success');
      } else {
        // Fallback trends
        trends.forEach((trend, index) => {
          trend.textContent = '‚Üí Simulado';
          trend.className = 'kpi-trend trend-stable';
        });
        debugLog('Trends dos KPIs atualizadas com fallback', 'warning');
      }
    }

    function loadData() {
      debugLog('Carregando dados em tempo real...', 'info');
      
      // Tentar carregar dados reais do Copernicus
      fetch('copernicus_authenticated_angola.json')
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          debugLog('Dados Copernicus carregados: ' + data.source, 'success');
          
          // Atualizar KPIs com dados reais
          const avgSST = data.summary_statistics?.avg_sst || 24.3;
          const maxChl = data.summary_statistics?.max_chlorophyll || 2.8;
          
          document.getElementById('sst-value').textContent = avgSST.toFixed(1) + '¬∞C';
          document.getElementById('chl-value').textContent = maxChl.toFixed(1);
          document.getElementById('current-value').textContent = '0.45';
          document.getElementById('wind-value').textContent = '12';
          document.getElementById('vessels-value').textContent = '47';
          document.getElementById('observations-value').textContent = '156';

          // Atualizar trends dos KPIs (CORRIGIDO)
          updateKPITrends(data);

          // Atualizar dados oceanogr√°ficos com dados reais
          const avgSalinity = data.real_time_data?.reduce((sum, point) => sum + point.salinity, 0) / data.real_time_data?.length || 35.2;
          document.getElementById('upwelling-index').textContent = data.summary_statistics?.upwelling_active ? '0.85' : '0.45';
          document.getElementById('salinity').textContent = avgSalinity.toFixed(1);
          document.getElementById('ph-value').textContent = '8.1';
          document.getElementById('oxygen').textContent = '6.8';
          
          // Atualizar status
          document.getElementById('copernicusStatus').className = 'status-dot status-online';
          
          debugLog('Dados em tempo real atualizados', 'success');
        })
        .catch(error => {
          debugLog('Erro ao carregar dados Copernicus: ' + error.message, 'error');
          debugLog('Usando dados fallback...', 'warning');
          
          // Dados fallback
          document.getElementById('sst-value').textContent = '24.3¬∞C';
          document.getElementById('chl-value').textContent = '2.8';
          document.getElementById('current-value').textContent = '0.45';
          document.getElementById('wind-value').textContent = '12';
          document.getElementById('vessels-value').textContent = '47';
          document.getElementById('observations-value').textContent = '156';
          
          document.getElementById('upwelling-index').textContent = '0.73';
          document.getElementById('salinity').textContent = '35.2';
          document.getElementById('ph-value').textContent = '8.1';
          document.getElementById('oxygen').textContent = '6.8';
          
          // Atualizar trends para fallback (CORRIGIDO)
          updateKPITrends(null);
          
          debugLog('Dados fallback carregados', 'success');
        });
    }

    function tryFallback() {
      debugLog('Tentando sistema de fallback...', 'warning');
      
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.onload = async () => {
        debugLog('Leaflet carregado via fallback', 'success');
        try {
          initializeMap();
          loadData();
          document.getElementById('systemStatus').textContent = 'FALLBACK';
        } catch (error) {
          debugLog('Fallback tamb√©m falhou: ' + error.message, 'error');
          document.getElementById('systemStatus').textContent = 'CR√çTICO';
        }
      };
      script.onerror = () => {
        debugLog('Fallback falhou completamente', 'error');
        document.getElementById('systemStatus').textContent = 'OFFLINE';
      };
      document.head.appendChild(script);
    }

    function updateMapTimestamp() {
      const now = new Date();
      document.getElementById('mapUpdate').textContent = now.toLocaleTimeString('pt-PT');
    }

    function updateClock() {
      const now = new Date();
      document.getElementById('currentTime').textContent = now.toLocaleTimeString('pt-PT');
    }

    // Armazenar camadas ativas
    let activeLayers = {
      sst: true,
      chlorophyll: false,
      currents: false,
      vessels: false,
      observations: false
    };

    function toggleLayer(layerType) {
      debugLog(`Camada selecionada: ${layerType}`, 'info');
      
      // Atualizar estado da camada
      activeLayers[layerType] = !activeLayers[layerType];
      
      // Atualizar bot√£o visual
      const button = event.target;
      if (activeLayers[layerType]) {
        button.classList.add('active');
        debugLog(`‚úÖ Camada ${layerType} ativada`, 'success');
      } else {
        button.classList.remove('active');
        debugLog(`‚ùå Camada ${layerType} desativada`, 'info');
      }
      
      // Implementar l√≥gica real das camadas (CORRIGIDO)
      implementLayerLogic(layerType, activeLayers[layerType]);
    }
    
    // Fun√ß√£o para implementar l√≥gica real das camadas (NOVA)
    function implementLayerLogic(layerType, isActive) {
      if (!app.map) {
        debugLog('Mapa n√£o dispon√≠vel para controle de camadas', 'warning');
        return;
      }
      
      switch(layerType) {
        case 'sst':
          if (isActive) {
            // Simular camada SST
            addTemperatureOverlay();
          } else {
            removeTemperatureOverlay();
          }
          break;
          
        case 'chlorophyll':
          if (isActive) {
            // Simular camada Clorofila
            addChlorophyllOverlay();
          } else {
            removeChlorophyllOverlay();
          }
          break;
          
        case 'currents':
          if (isActive) {
            addCurrentsOverlay();
          } else {
            removeCurrentsOverlay();
          }
          break;
          
        case 'vessels':
          if (isActive) {
            addVesselsOverlay();
          } else {
            removeVesselsOverlay();
          }
          break;
          
        case 'observations':
          if (isActive) {
            addObservationsOverlay();
          } else {
            removeObservationsOverlay();
          }
          break;
      }
      
      debugLog(`L√≥gica da camada ${layerType} implementada (${isActive ? 'ON' : 'OFF'})`, 'info');
    }
    
    // Fun√ß√µes para controlar camadas espec√≠ficas (NOVAS)
    let temperatureLayer = null;
    let chlorophyllLayer = null;
    let currentsLayer = null;
    let vesselsLayer = null;
    let observationsLayer = null;
    
    function addTemperatureOverlay() {
      if (temperatureLayer) return;
      
      // Simular overlay de temperatura com pontos coloridos
      temperatureLayer = L.layerGroup();
      
      const tempPoints = [
        { lat: -5.5, lon: 11.9, temp: 25.8, color: '#ff4444' },
        { lat: -8.8, lon: 12.8, temp: 22.1, color: '#ff8844' },
        { lat: -12.6, lon: 12.9, temp: 18.9, color: '#44ff44' },
        { lat: -15.2, lon: 11.6, temp: 16.2, color: '#4444ff' }
      ];
      
      tempPoints.forEach(point => {
        L.circleMarker([point.lat, point.lon], {
          radius: 8,
          fillColor: point.color,
          color: point.color,
          weight: 2,
          opacity: 0.8,
          fillOpacity: 0.6
        }).bindPopup(`üå°Ô∏è SST: ${point.temp}¬∞C`).addTo(temperatureLayer);
      });
      
      temperatureLayer.addTo(app.map);
      debugLog('Camada SST adicionada', 'success');
    }
    
    function removeTemperatureOverlay() {
      if (temperatureLayer) {
        app.map.removeLayer(temperatureLayer);
        temperatureLayer = null;
        debugLog('Camada SST removida', 'info');
      }
    }
    
    function addChlorophyllOverlay() {
      if (chlorophyllLayer) return;
      
      chlorophyllLayer = L.layerGroup();
      
      const chlPoints = [
        { lat: -5.5, lon: 11.9, chl: 2.3, color: '#90EE90' },
        { lat: -8.8, lon: 12.8, chl: 4.2, color: '#32CD32' },
        { lat: -12.6, lon: 12.9, chl: 7.8, color: '#228B22' },
        { lat: -15.2, lon: 11.6, chl: 12.1, color: '#006400' }
      ];
      
      chlPoints.forEach(point => {
        L.circleMarker([point.lat, point.lon], {
          radius: 10,
          fillColor: point.color,
          color: point.color,
          weight: 2,
          opacity: 0.8,
          fillOpacity: 0.6
        }).bindPopup(`üå± Chl-a: ${point.chl} mg/m¬≥`).addTo(chlorophyllLayer);
      });
      
      chlorophyllLayer.addTo(app.map);
      debugLog('Camada Clorofila adicionada', 'success');
    }
    
    function removeChlorophyllOverlay() {
      if (chlorophyllLayer) {
        app.map.removeLayer(chlorophyllLayer);
        chlorophyllLayer = null;
        debugLog('Camada Clorofila removida', 'info');
      }
    }
    
    function addCurrentsOverlay() {
      if (currentsLayer) return;
      
      currentsLayer = L.layerGroup();
      
      // Simular setas de correntes
      const currentVectors = [
        { lat: -8, lon: 12.7, direction: 180, speed: 0.3 },
        { lat: -12, lon: 12.8, direction: 200, speed: 0.5 },
        { lat: -15, lon: 11.7, direction: 220, speed: 0.8 }
      ];
      
      currentVectors.forEach(vector => {
        L.marker([vector.lat, vector.lon], {
          icon: L.divIcon({
            html: '‚Üí',
            className: 'current-arrow',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          })
        }).bindPopup(`üåä Corrente: ${vector.speed} m/s`).addTo(currentsLayer);
      });
      
      currentsLayer.addTo(app.map);
      debugLog('Camada Correntes adicionada', 'success');
    }
    
    function removeCurrentsOverlay() {
      if (currentsLayer) {
        app.map.removeLayer(currentsLayer);
        currentsLayer = null;
        debugLog('Camada Correntes removida', 'info');
      }
    }
    
    function addVesselsOverlay() {
      if (vesselsLayer) return;
      
      vesselsLayer = L.layerGroup();
      
      // Simular embarca√ß√µes
      const vessels = [
        { lat: -6, lon: 12.2, type: 'Pesqueiro', name: 'Maria Fernanda' },
        { lat: -9, lon: 12.7, type: 'Cargueiro', name: 'Atlantic Star' },
        { lat: -13, lon: 12.9, type: 'Pesqueiro', name: 'Benguela' }
      ];
      
      vessels.forEach(vessel => {
        L.marker([vessel.lat, vessel.lon], {
          icon: L.divIcon({
            html: 'üö¢',
            className: 'vessel-icon',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          })
        }).bindPopup(`üö¢ ${vessel.name}<br>Tipo: ${vessel.type}`).addTo(vesselsLayer);
      });
      
      vesselsLayer.addTo(app.map);
      debugLog('Camada Embarca√ß√µes adicionada', 'success');
    }
    
    function removeVesselsOverlay() {
      if (vesselsLayer) {
        app.map.removeLayer(vesselsLayer);
        vesselsLayer = null;
        debugLog('Camada Embarca√ß√µes removida', 'info');
      }
    }
    
    function addObservationsOverlay() {
      if (observationsLayer) return;
      
      observationsLayer = L.layerGroup();
      
      // Simular observa√ß√µes cient√≠ficas
      const observations = [
        { lat: -7, lon: 12.5, type: 'Pesca', species: 'Sardinha' },
        { lat: -11, lon: 12.8, type: 'Avistamento', species: 'Golfinho' },
        { lat: -14, lon: 12.2, type: 'Amostra', species: 'Pl√¢ncton' }
      ];
      
      observations.forEach(obs => {
        L.marker([obs.lat, obs.lon], {
          icon: L.divIcon({
            html: 'üêü',
            className: 'observation-icon',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
          })
        }).bindPopup(`üêü ${obs.species}<br>Tipo: ${obs.type}`).addTo(observationsLayer);
      });
      
      observationsLayer.addTo(app.map);
      debugLog('Camada Observa√ß√µes adicionada', 'success');
    }
    
    function removeObservationsOverlay() {
      if (observationsLayer) {
        app.map.removeLayer(observationsLayer);
        observationsLayer = null;
        debugLog('Camada Observa√ß√µes removida', 'info');
      }
    }
    
    function togglePanel() {
      debugLog('Toggle panel chamado', 'info');
      
      const panel = document.getElementById('mainPanel');
      const toggleBtn = panel?.querySelector('.panel-toggle');
      const floatingToggle = document.querySelector('.floating-toggle');
      
      if (!panel) {
        debugLog('ERRO: Painel mainPanel n√£o encontrado!', 'error');
        return;
      }
      
      const isCollapsed = panel.classList.contains('collapsed');
      debugLog(`Estado atual do painel: ${isCollapsed ? 'recolhido' : 'expandido'}`, 'info');
      
      if (isCollapsed) {
        // Expandir painel
        panel.classList.remove('collapsed');
        if (toggleBtn) toggleBtn.textContent = '‚Üê';
        if (floatingToggle) floatingToggle.classList.remove('visible');
        
        // Ajustar posi√ß√£o dos controles Leaflet
        adjustLeafletControlsPosition(false);
        
        debugLog('‚úÖ Painel expandido', 'success');
        
        // Invalidar tamanho do mapa ap√≥s anima√ß√£o
        setTimeout(() => {
          if (app.map && typeof app.map.invalidateSize === 'function') {
            app.map.invalidateSize();
            debugLog('Mapa redimensionado ap√≥s expandir painel', 'info');
          }
        }, 350);
        
      } else {
        // Recolher painel
        panel.classList.add('collapsed');
        if (toggleBtn) toggleBtn.textContent = '‚Üí';
        
        // Ajustar posi√ß√£o dos controles Leaflet
        adjustLeafletControlsPosition(true);
        
        debugLog('‚úÖ Painel recolhido', 'success');
        
        // Mostrar bot√£o flutuante ap√≥s delay
        setTimeout(() => {
          if (floatingToggle) floatingToggle.classList.add('visible');
          debugLog('Bot√£o flutuante mostrado', 'info');
        }, 300);
        
        // Invalidar tamanho do mapa ap√≥s anima√ß√£o
        setTimeout(() => {
          if (app.map && typeof app.map.invalidateSize === 'function') {
            app.map.invalidateSize();
            debugLog('Mapa redimensionado ap√≥s recolher painel', 'info');
          }
        }, 350);
      }
      
      // Debug: mostrar classes atuais do painel
      debugLog(`Classes do painel: ${panel.className}`, 'info');
    }
    
    // Nova fun√ß√£o para ajustar posi√ß√£o dos controles Leaflet
    function adjustLeafletControlsPosition(panelCollapsed) {
      debugLog(`Ajustando controles Leaflet - painel ${panelCollapsed ? 'recolhido' : 'expandido'}`, 'info');
      
      const leafletControls = document.querySelector('.leaflet-top.leaflet-left');
      if (leafletControls) {
        // Posicionar no canto inferior esquerdo
        leafletControls.style.top = 'auto';
        leafletControls.style.bottom = '24px';
        
        if (panelCollapsed) {
          // Painel recolhido - posi√ß√£o padr√£o
          leafletControls.style.left = '24px';
        } else {
          // Painel expandido - mover um pouco para a direita
          leafletControls.style.left = '60px';
        }
        leafletControls.style.transition = 'left 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        debugLog(`Controles Leaflet reposicionados - bottom: 24px, left: ${leafletControls.style.left}`, 'success');
      } else {
        debugLog('Controles Leaflet n√£o encontrados para reposicionamento', 'warning');
      }
    }

    function toggleInternalWaters() {
      debugLog('Alternando √°guas internas...', 'info');
      const btn = document.getElementById('internal-waters-btn');
      
      if (btn.classList.contains('active')) {
        btn.classList.remove('active');
        debugLog('√Åguas internas ocultadas', 'info');
      } else {
        btn.classList.add('active');
        debugLog('√Åguas internas mostradas', 'info');
      }
    }

    function testMapFunctionality() {
      if (!app.map) {
        debugLog('Mapa n√£o est√° dispon√≠vel para teste', 'warning');
        return;
      }
      
      debugLog('Testando funcionalidades do mapa...', 'info');
      
      try {
        // Testar zoom
        app.map.setZoom(8);
        setTimeout(() => app.map.setZoom(6), 1000);
        
        // Testar pan
        app.map.panTo([-15, 12]);
        setTimeout(() => app.map.panTo([-12.5, 13.5]), 1500);
        
        // Adicionar marcador de teste
        const testMarker = L.marker([-10, 13])
          .addTo(app.map)
          .bindPopup('üß™ Teste de funcionalidade!')
          .openPopup();
        
        // Remover ap√≥s 3 segundos
        setTimeout(() => {
          app.map.removeLayer(testMarker);
          debugLog('Teste de funcionalidade conclu√≠do', 'success');
        }, 3000);
        
      } catch (error) {
        debugLog('Erro no teste: ' + error.message, 'error');
      }
    }
    
    function testTogglePanel() {
      debugLog('=== TESTE TOGGLE PANEL ===', 'info');
      
      const panel = document.getElementById('mainPanel');
      if (!panel) {
        debugLog('‚ùå ERRO: mainPanel n√£o encontrado', 'error');
        return;
      }
      
      debugLog(`üìã Classes atuais: ${panel.className}`, 'info');
      debugLog(`üìè Transform atual: ${getComputedStyle(panel).transform}`, 'info');
      debugLog(`üëÅÔ∏è Opacity atual: ${getComputedStyle(panel).opacity}`, 'info');
      
      // For√ßar toggle
      debugLog('üîÑ For√ßando toggle...', 'info');
      togglePanel();
      
      // Verificar ap√≥s 1 segundo
      setTimeout(() => {
        debugLog('=== ESTADO AP√ìS TOGGLE ===', 'info');
        debugLog(`üìã Classes ap√≥s toggle: ${panel.className}`, 'info');
        debugLog(`üìè Transform ap√≥s toggle: ${getComputedStyle(panel).transform}`, 'info');
        debugLog(`üëÅÔ∏è Opacity ap√≥s toggle: ${getComputedStyle(panel).opacity}`, 'info');
      }, 1000);
    }
  </script>
</body>
</html>
